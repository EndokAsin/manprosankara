<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sankara NGO Project Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loading-spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #16a34a; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Timeline specific */
        .timeline-grid { display: grid; grid-template-columns: 150px repeat(12, 1fr); }
        .timeline-cell { border-right: 1px dashed #e2e8f0; position: relative; }
        .gantt-bar { transition: all 0.3s ease; }
        .gantt-bar:hover { filter: brightness(0.95); }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-5 right-5 z-50 transform transition-transform translate-x-full duration-300">
        <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-xl p-4 flex items-center pr-8">
            <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
            <div>
                <h4 class="font-bold text-sm text-gray-800">Notifikasi</h4>
                <span id="toast-msg" class="text-sm text-gray-600">Message</span>
            </div>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col z-20 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <div class="p-6 flex items-center border-b border-slate-100">
                <div class="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center text-white font-bold mr-3 shadow-lg shadow-green-200">S</div>
                <h1 class="text-xl font-bold tracking-tight text-slate-800">SANKARA <span class="text-green-600">PM</span></h1>
            </div>
            <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-1">
                <button onclick="app.showPage('dashboard')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-green-50 text-slate-600 hover:text-green-700 font-medium transition flex items-center group">
                    <i class="fas fa-chart-pie w-6 text-slate-400 group-hover:text-green-600 transition"></i> Dashboard & Gantt
                </button>
                <button onclick="app.showPage('projects')" class="w-full text-left px-4 py-3 rounded-xl bg-green-50 text-green-700 font-medium transition flex items-center shadow-sm shadow-green-100 ring-1 ring-green-200">
                    <i class="fas fa-layer-group w-6"></i> Manajemen Proyek
                </button>
            </nav>
            <div class="p-4 border-t border-slate-100 bg-slate-50">
                <button onclick="app.generateBandungData()" class="w-full bg-white border border-green-200 text-green-700 text-xs py-2.5 px-3 rounded-lg hover:bg-green-50 transition font-semibold shadow-sm flex justify-center items-center">
                    <i class="fas fa-magic mr-2"></i> Generate Dummy
                </button>
                <div class="mt-3 flex items-center justify-center text-[10px] text-slate-400">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-1.5 animate-pulse"></span> Connected to Supabase
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-[#f8fafc]">
            
            <!-- Mobile Header -->
            <header class="md:hidden bg-white border-b p-4 flex justify-between items-center shadow-sm z-20">
                <div class="font-bold text-green-700 flex items-center gap-2">
                    <div class="w-6 h-6 bg-green-600 rounded text-white flex items-center justify-center text-xs">S</div>
                    SANKARA
                </div>
                <button class="text-slate-600"><i class="fas fa-bars"></i></button>
            </header>

            <!-- Content Area -->
            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth custom-scrollbar">
                <div class="flex flex-col justify-center items-center h-full text-slate-400">
                    <div class="loading-spinner mb-3"></div>
                    <span class="text-sm font-medium">Memuat Data...</span>
                </div>
            </div>
        </main>
    </div>

    <!-- Error State Template -->
    <template id="error-db-template">
        <div class="flex flex-col items-center justify-center h-full text-center p-6">
            <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center text-red-500 mb-6 text-3xl">
                <i class="fas fa-database"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Tabel Database Tidak Ditemukan</h2>
            <p class="text-slate-500 max-w-md mb-6">
                Silakan jalankan script setup_database.sql di Supabase SQL Editor terlebih dahulu.
            </p>
            <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold transition">
                <i class="fas fa-sync-alt mr-2"></i> Coba Lagi
            </button>
        </div>
    </template>

    <!-- MODALS -->

    <!-- Modal Project (With Add Regional Support) -->
    <div id="modal-project" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
            <div class="bg-white px-6 py-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800" id="modal-project-title">Proyek Baru</h3>
                <button onclick="app.toggleModal('modal-project')" class="text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="form-project" class="p-6 space-y-4">
                <input type="hidden" name="id" id="project-id">
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Nama Kegiatan</label>
                    <input type="text" name="title" id="project-title" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500/20 focus:border-green-500 outline-none transition">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Regional</label>
                        <!-- INPUT LIST FOR ADDING NEW REGIONAL -->
                        <input type="text" list="regional-list" name="regional" id="project-regional" placeholder="Pilih / Ketik Baru..." required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500/20 focus:border-green-500 outline-none transition">
                        <datalist id="regional-list">
                            <option value="Bandung">
                            <option value="Jakarta">
                            <option value="Surabaya">
                            <option value="Yogyakarta">
                            <option value="Lainnya">
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Project Leader</label>
                        <input type="text" name="leader" id="project-leader" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500/20 focus:border-green-500 outline-none transition">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Tema</label>
                    <input type="text" name="theme" id="project-theme" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500/20 focus:border-green-500 outline-none transition">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Tanggal (D-Day)</label>
                        <input type="date" name="event_date" id="project-date" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500/20 focus:border-green-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Lokasi</label>
                        <input type="text" name="location" id="project-location" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500/20 focus:border-green-500 outline-none transition">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Status Tahapan (SOP)</label>
                    <select name="status" id="project-status" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500/20 focus:border-green-500 outline-none transition">
                        <option value="Tahap 1: Submit Proposal">1. Submit Proposal (Max H-18)</option>
                        <option value="Tahap 2: Media & Finance">2. Media & Finance (Max H-15)</option>
                        <option value="Tahap 3: Rekrutmen & Pembelian">3. Rekrutmen & Pembelian (H-15 s/d H-5)</option>
                        <option value="Tahap 4: First Meet">4. First Meet (H-3)</option>
                        <option value="Tahap 5: Kegiatan">5. Kegiatan (H-0)</option>
                        <option value="Tahap 6: Laporan">6. Laporan (Max H+2)</option>
                    </select>
                </div>
                <div class="pt-2">
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-green-200">Simpan Proyek</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Modal -->
    <div id="modal-generic" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800" id="modal-generic-title">Modal</h3>
                <button onclick="app.toggleModal('modal-generic')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-generic-content" class="p-6"></div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://ruehfvjwdasqpzmroaau.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1ZWhmdmp3ZGFzcXB6bXJvYWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MjAwMzgsImV4cCI6MjA3OTk5NjAzOH0.T96V7eHlNpBDV6yIJN1WbFXXb8LUYbA3yWDloY_jya8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- UPDATED SOP STEPS (6 STEPS) ---
        const SOP_STEPS = [
            { id: 1, name: "Proposal", desc: "Max H-18" },
            { id: 2, name: "Media & Fin", desc: "Max H-15" },
            { id: 3, name: "Rekrutmen", desc: "H-15 s/d H-5" },
            { id: 4, name: "First Meet", desc: "H-3" },
            { id: 5, name: "Kegiatan", desc: "H-0" },
            { id: 6, name: "Laporan", desc: "Max H+2" }
        ];

        const app = {
            currentPage: 'projects',
            activeProjectId: null,
            projects: [],
            
            init: async () => {
                await app.fetchProjects();
                app.showPage('projects');
                
                document.getElementById('form-project').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await app.handleFormSubmit(e.target, 'projects', app.fetchProjects);
                });
            },

            // --- NAVIGATION ---
            showPage: (pageName) => {
                app.currentPage = pageName;
                const container = document.getElementById('content-area');
                if (pageName === 'dashboard') app.renderDashboard(container);
                else if (pageName === 'projects') { app.activeProjectId = null; app.renderProjectList(container); }
            },

            // --- DATA FETCHING ---
            fetchProjects: async () => {
                const { data, error } = await supabase.from('projects').select('*').order('event_date', { ascending: true });
                if (error) {
                    console.error(error);
                    if (error.code === '42P01') { // Missing table
                        document.getElementById('content-area').innerHTML = '';
                        document.getElementById('content-area').appendChild(document.getElementById('error-db-template').content.cloneNode(true));
                    } else {
                        app.showToast("Gagal koneksi: " + error.message);
                    }
                } else {
                    app.projects = data;
                    if (app.currentPage === 'projects') app.renderProjectList(document.getElementById('content-area'));
                }
            },

            getProjectDetails: async (id) => {
                app.activeProjectId = id;
                app.currentPage = 'detail';
                const [proj, rundowns, budgets, volunteers, files] = await Promise.all([
                    supabase.from('projects').select('*').eq('id', id).single(),
                    supabase.from('rundowns').select('*').eq('project_id', id).order('time_start', {ascending: true}),
                    supabase.from('budgets').select('*').eq('project_id', id),
                    supabase.from('volunteers').select('*').eq('project_id', id),
                    supabase.from('project_files').select('*').eq('project_id', id)
                ]);

                if (!proj.data) { app.showToast("Error loading project"); return; }
                app.renderProjectDetailView(proj.data, rundowns.data || [], budgets.data || [], volunteers.data || [], files.data || []);
            },

            // --- RENDER DASHBOARD (MASTER GANTT) ---
            renderDashboard: (container) => {
                const total = app.projects.length;
                const completed = app.projects.filter(p => p.status.includes('Tahap 6')).length;
                const ongoing = total - completed;

                // Group Projects by Regional
                const regionals = [...new Set(app.projects.map(p => p.regional || 'Lainnya'))].sort();
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];

                let timelineHtml = '';
                
                regionals.forEach(reg => {
                    const regionalProjects = app.projects.filter(p => (p.regional || 'Lainnya') === reg);
                    
                    timelineHtml += `
                        <div class="border-b border-slate-100 hover:bg-slate-50 transition">
                            <div class="flex items-stretch min-h-[60px]">
                                <!-- Regional Header (Left Sticky) -->
                                <div class="w-[150px] flex-shrink-0 bg-white border-r border-slate-200 p-3 flex flex-col justify-center sticky left-0 z-10 shadow-[4px_0_4px_-2px_rgba(0,0,0,0.05)]">
                                    <span class="font-bold text-slate-700 text-sm truncate" title="${reg}">${reg}</span>
                                    <span class="text-[10px] text-slate-400">${regionalProjects.length} Event</span>
                                </div>
                                
                                <!-- Timeline Grid -->
                                <div class="flex-1 grid grid-cols-12 relative min-w-[800px]">
                                    <!-- Grid Lines -->
                                    ${months.map(() => `<div class="border-r border-dashed border-slate-200 h-full"></div>`).join('')}
                                    
                                    <!-- Project Bars -->
                                    ${regionalProjects.map(p => {
                                        if (!p.event_date) return '';
                                        const d = new Date(p.event_date);
                                        const mIndex = d.getMonth(); // 0-11
                                        // Simple Logic: Show a dot/bar at the event month
                                        return `
                                            <div class="absolute top-1/2 -translate-y-1/2 h-8 bg-green-100 border border-green-300 rounded-md px-2 flex items-center shadow-sm cursor-pointer hover:bg-green-200 z-0 text-xs text-green-800 font-medium whitespace-nowrap overflow-hidden transition"
                                                 style="left: calc(${(mIndex * (100/12))}% + 5px); width: calc((100%/12) * 1.5);"
                                                 onclick="app.getProjectDetails('${p.id}')">
                                                 <div class="w-2 h-2 rounded-full bg-green-600 mr-2 flex-shrink-0"></div>
                                                 ${p.title}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = `
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-slate-800">Dashboard & Master Timeline</h2>
                        <p class="text-slate-500">Monitoring seluruh event per regional</p>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-5 rounded-xl border border-slate-200 flex items-center shadow-sm">
                            <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mr-4"><i class="fas fa-folder"></i></div>
                            <div><div class="text-2xl font-bold">${total}</div><div class="text-xs text-slate-500">Total Proyek</div></div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-slate-200 flex items-center shadow-sm">
                            <div class="w-10 h-10 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mr-4"><i class="fas fa-clock"></i></div>
                            <div><div class="text-2xl font-bold">${ongoing}</div><div class="text-xs text-slate-500">Sedang Berjalan</div></div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-slate-200 flex items-center shadow-sm">
                            <div class="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center mr-4"><i class="fas fa-flag-checkered"></i></div>
                            <div><div class="text-2xl font-bold">${completed}</div><div class="text-xs text-slate-500">Selesai</div></div>
                        </div>
                    </div>

                    <!-- MASTER TIMELINE GANTT -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-10">
                        <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700"><i class="fas fa-stream mr-2"></i> Timeline Event 2025</h3>
                            <span class="text-xs text-slate-400">Scroll horizontal untuk melihat detail</span>
                        </div>
                        <div class="overflow-x-auto custom-scrollbar">
                            <div class="min-w-[950px]">
                                <!-- Header Months -->
                                <div class="flex border-b border-slate-200 bg-slate-50 text-xs font-bold text-slate-500 uppercase">
                                    <div class="w-[150px] p-3 flex-shrink-0 sticky left-0 bg-slate-50 z-20 border-r border-slate-200">Regional</div>
                                    <div class="flex-1 grid grid-cols-12 text-center">
                                        ${months.map(m => `<div class="p-3 border-r border-slate-200">${m}</div>`).join('')}
                                    </div>
                                </div>
                                <!-- Body -->
                                ${regionals.length > 0 ? timelineHtml : '<div class="p-8 text-center text-slate-400 italic">Belum ada data proyek.</div>'}
                            </div>
                        </div>
                    </div>
                `;
            },

            // --- RENDER PROJECT LIST (GROUPED BY REGIONAL) ---
            renderProjectList: (container) => {
                const groups = app.projects.reduce((acc, project) => {
                    const reg = project.regional || 'Lainnya';
                    if (!acc[reg]) acc[reg] = [];
                    acc[reg].push(project);
                    return acc;
                }, {});

                let html = `
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Manajemen Proyek</h2>
                            <p class="text-slate-500 text-sm">Daftar kegiatan dikelompokkan per regional</p>
                        </div>
                        <button onclick="app.openProjectModal()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl font-bold transition shadow-md shadow-green-200 flex items-center gap-2">
                            <i class="fas fa-plus"></i> Buat Proyek
                        </button>
                    </div>
                `;

                if (Object.keys(groups).length === 0) {
                    html += `<div class="text-center py-20 text-slate-400">Belum ada data.</div>`;
                } else {
                    for (const [regional, projects] of Object.entries(groups)) {
                        html += `
                            <div class="mb-8">
                                <div class="flex items-center gap-3 mb-4">
                                    <span class="bg-slate-800 text-white text-xs font-bold px-3 py-1.5 rounded-lg uppercase tracking-wider shadow-sm">${regional}</span>
                                    <div class="h-[1px] bg-slate-200 flex-1"></div>
                                </div>
                                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                    <table class="w-full text-left">
                                        <thead>
                                            <tr class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-100">
                                                <th class="p-4 font-semibold">Kegiatan</th>
                                                <th class="p-4 font-semibold hidden md:table-cell">Leader</th>
                                                <th class="p-4 font-semibold">Tanggal</th>
                                                <th class="p-4 font-semibold text-center">Progress</th>
                                                <th class="p-4 font-semibold text-right">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-50">
                                            ${projects.map(p => {
                                                const stepNum = parseInt((p.status||'').split(':')[0].replace('Tahap ','') || 1);
                                                const pct = (stepNum/6)*100; // Updated division by 6
                                                return `
                                                <tr class="hover:bg-slate-50 transition cursor-pointer" onclick="app.getProjectDetails('${p.id}')">
                                                    <td class="p-4 font-medium text-slate-800">${p.title}<div class="text-xs text-slate-400 font-normal md:hidden">${p.leader}</div></td>
                                                    <td class="p-4 text-slate-600 text-sm hidden md:table-cell">${p.leader}</td>
                                                    <td class="p-4 text-slate-600 text-sm">${app.formatDate(p.event_date)}</td>
                                                    <td class="p-4 w-32">
                                                        <div class="w-full bg-slate-100 rounded-full h-1.5">
                                                            <div class="bg-green-500 h-1.5 rounded-full" style="width: ${pct}%"></div>
                                                        </div>
                                                        <div class="text-[10px] text-center text-slate-400 mt-1">Tahap ${stepNum}/6</div>
                                                    </td>
                                                    <td class="p-4 text-right">
                                                        <button onclick="event.stopPropagation(); app.deleteItem('projects', '${p.id}')" class="text-slate-300 hover:text-red-500 p-2"><i class="fas fa-trash"></i></button>
                                                    </td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }
                }
                container.innerHTML = html;
            },

            // --- RENDER DETAIL VIEW ---
            renderProjectDetailView: (project, rundowns, budgets, volunteers, files) => {
                const container = document.getElementById('content-area');
                const safeProj = JSON.stringify(project).replace(/"/g, '&quot;');
                let currentStep = 1;
                if (project.status && project.status.includes('Tahap')) currentStep = parseInt(project.status.split(':')[0].replace('Tahap ', ''));
                const totalBudget = budgets.reduce((sum, b) => sum + (b.total_price || 0), 0);

                let html = `
                    <div class="flex items-center gap-2 text-sm text-slate-500 mb-6">
                        <button onclick="app.showPage('projects')" class="hover:text-green-600 transition">Projects</button>
                        <i class="fas fa-chevron-right text-xs"></i>
                        <span class="text-slate-800 font-semibold truncate">${project.title}</span>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 mb-6 relative group">
                        <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition z-10">
                            <button onclick="app.openProjectModal(${safeProj})" class="bg-slate-100 text-slate-600 hover:text-green-600 px-3 py-1.5 rounded-lg text-sm transition"><i class="fas fa-pen mr-1"></i> Edit</button>
                        </div>
                        <div class="flex flex-col md:flex-row justify-between md:items-start gap-4">
                            <div>
                                <span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded mb-3 inline-block uppercase tracking-wider">${project.regional}</span>
                                <h1 class="text-3xl font-bold text-slate-800 mb-2">${project.title}</h1>
                                <p class="text-slate-600"><span class="font-semibold">Tema:</span> ${project.theme}</p>
                            </div>
                            <div class="text-right"><div class="text-xl font-bold text-slate-800">${app.formatDate(project.event_date)}</div><div class="text-xs text-slate-500">${project.location}</div></div>
                        </div>

                        <!-- Stepper -->
                        <div class="mt-8 pt-6 border-t border-slate-100 flex items-center justify-between w-full overflow-x-auto pb-2">
                            ${SOP_STEPS.map((step, idx) => `
                                <div class="flex flex-col items-center relative flex-1 min-w-[80px]">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold mb-2 border-2 ${step.id <= currentStep ? 'bg-green-500 border-green-500 text-white' : 'bg-white border-slate-200 text-slate-300'}">${step.id}</div>
                                    <div class="text-[10px] font-bold text-center ${step.id <= currentStep ? 'text-slate-800' : 'text-slate-400'}">${step.name}</div>
                                    <div class="text-[9px] text-slate-400 text-center">${step.desc}</div>
                                    ${idx !== SOP_STEPS.length - 1 ? `<div class="absolute top-4 left-[50%] w-full h-[2px] -z-10 ${step.id < currentStep ? 'bg-green-500' : 'bg-slate-200'}"></div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 pb-20">
                        <div class="lg:col-span-2 space-y-6">
                            
                            <!-- INDIVIDUAL EVENT TIMELINE (GANTT) -->
                            <div class="bg-white rounded-2xl p-6 border border-slate-200">
                                <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-stream text-green-500"></i> Timeline Persiapan</h3>
                                ${app.renderGanttChart(project.event_date)}
                            </div>

                            <!-- Rundown -->
                            <div class="bg-white rounded-2xl p-6 border border-slate-200">
                                <div class="flex justify-between mb-4"><h3 class="font-bold">Rundown</h3><button onclick="app.openRundownModal()" class="text-xs bg-green-50 text-green-600 px-3 py-1 rounded-lg font-bold">+ Item</button></div>
                                <div class="space-y-4 border-l-2 border-slate-100 ml-2 pl-6">
                                    ${rundowns.map(r => `
                                        <div class="relative group">
                                            <div class="absolute -left-[31px] top-1 w-3 h-3 bg-white border-2 border-green-500 rounded-full"></div>
                                            <div class="flex justify-between">
                                                <div><span class="text-xs font-bold bg-slate-100 px-1 rounded">${r.time_start}-${r.time_end}</span><div class="font-bold mt-1">${r.activity}</div><div class="text-xs text-slate-500">${r.description||''}</div></div>
                                                <div class="opacity-0 group-hover:opacity-100"><button onclick='app.openRundownModal(${JSON.stringify(r).replace(/"/g, '&quot;')})' class="text-blue-500"><i class="fas fa-pen"></i></button> <button onclick="app.deleteItem('rundowns','${r.id}')" class="text-red-400"><i class="fas fa-trash"></i></button></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${rundowns.length===0 ? '<div class="text-slate-400 text-sm italic">Belum ada rundown</div>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <!-- Budget -->
                            <div class="bg-white rounded-2xl p-6 border border-slate-200">
                                <div class="flex justify-between mb-4"><h3 class="font-bold">Budget</h3><button onclick="app.openBudgetModal()" class="text-xs bg-slate-100 px-2 py-1 rounded">+ Item</button></div>
                                <div class="text-2xl font-bold mb-3">${app.formatCurrency(totalBudget)}</div>
                                <div class="max-h-[300px] overflow-y-auto space-y-2">
                                    ${budgets.map(b => `<div class="flex justify-between text-sm p-2 hover:bg-slate-50 rounded group"><div>${b.item_name}<div class="text-xs text-slate-400">${b.quantity}</div></div><div class="text-right font-bold">${app.formatCurrency(b.total_price)}<div class="opacity-0 group-hover:opacity-100 text-xs font-normal"><button onclick='app.openBudgetModal(${JSON.stringify(b)})' class="text-blue-500 mr-2"><i class="fas fa-pen"></i></button><button onclick="app.deleteItem('budgets','${b.id}')" class="text-red-400"><i class="fas fa-trash"></i></button></div></div></div>`).join('')}
                                </div>
                            </div>
                             <!-- Volunteers -->
                            <div class="bg-white rounded-2xl p-6 border border-slate-200">
                                <div class="flex justify-between mb-4"><h3 class="font-bold">Divisi</h3><button onclick="app.openVolunteerModal()" class="text-xs bg-slate-100 px-2 py-1 rounded">+ Divisi</button></div>
                                <div class="space-y-2">
                                    ${volunteers.map(v => `<div class="bg-slate-50 p-2 rounded text-sm flex justify-between group"><span>${v.role_name} (${v.count})</span><div class="opacity-0 group-hover:opacity-100"><button onclick='app.openVolunteerModal(${JSON.stringify(v)})' class="text-blue-500 mr-2"><i class="fas fa-pen"></i></button><button onclick="app.deleteItem('volunteers','${v.id}')" class="text-red-400"><i class="fas fa-trash"></i></button></div></div>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML = html;
            },

            // --- GANTT RENDERER HELPER ---
            renderGanttChart: (eventDateStr) => {
                if(!eventDateStr) return '<div class="text-center text-slate-400 text-sm py-4">Tentukan tanggal acara untuk melihat timeline</div>';
                
                // UPDATED TIMELINE BASED ON USER REQUEST
                const timeline = [
                    { name: "Submit Proposal (Max H-18)", startDaysBefore: 25, duration: 7, color: "bg-purple-400" }, // Est. 1 week prep
                    { name: "Media & Finance (Max H-15)", startDaysBefore: 18, duration: 3, color: "bg-blue-400" },
                    { name: "Rekrutmen (H-15 s/d H-5)", startDaysBefore: 15, duration: 10, color: "bg-teal-400" },
                    { name: "Pembelian (H-15 s/d Meet)", startDaysBefore: 15, duration: 12, color: "bg-yellow-400" }, // H-15 to H-3
                    { name: "First Meet (H-3)", startDaysBefore: 3, duration: 1, color: "bg-orange-400" },
                    { name: "Kegiatan (H-0)", startDaysBefore: 0, duration: 1, color: "bg-green-500" },
                    { name: "Laporan (Max H+2)", startDaysBefore: -1, duration: 2, color: "bg-slate-400" } 
                ];

                let html = `<div class="w-full text-xs"><div class="grid grid-cols-6 gap-1 mb-2 text-slate-400 font-bold border-b pb-2 text-center"><div>W-6</div><div>W-5</div><div>W-4</div><div>W-3</div><div>W-2</div><div>W-1</div></div>`;
                timeline.forEach(item => {
                    const viewSpan = 50; const startPos = 45 - item.startDaysBefore; 
                    const leftPercent = (startPos / viewSpan) * 100; const widthPercent = (item.duration / viewSpan) * 100;
                    html += `<div class="mb-3"><div class="flex justify-between mb-1"><span class="font-medium text-slate-600">${item.name}</span><span class="text-[10px] text-slate-400">${item.startDaysBefore > 0 ? `H-${item.startDaysBefore}` : (item.startDaysBefore == 0 ? 'H-0' : `H+${Math.abs(item.startDaysBefore)}`)}</span></div><div class="w-full bg-slate-100 rounded-full h-2 relative overflow-hidden"><div class="absolute h-full rounded-full ${item.color} gantt-bar" style="left: ${Math.max(0, leftPercent)}%; width: ${widthPercent}%"></div></div></div>`;
                });
                return html + `</div>`;
            },

            // --- UTILS (MODAL OPENERS & HELPERS) ---
            handleFormSubmit: async (form, table, cb) => {
                const fd = new FormData(form); const data = Object.fromEntries(fd); const id = data.id; delete data.id;
                const { error } = id ? await supabase.from(table).update(data).eq('id',id) : await supabase.from(table).insert([data]);
                if(error) app.showToast("Error: " + error.message);
                else { app.showToast("Berhasil!"); app.toggleModal(form.closest('.fixed').id); form.reset(); if(cb) cb(); else if(app.activeProjectId) app.getProjectDetails(app.activeProjectId); }
            },
            deleteItem: async (table, id) => { if(confirm("Hapus?")) { await supabase.from(table).delete().eq('id', id); if(table==='projects') { await app.fetchProjects(); app.showPage('projects'); } else app.getProjectDetails(app.activeProjectId); } },
            toggleModal: (id) => { const m = document.getElementById(id); m.classList.toggle('hidden'); },
            openProjectModal: (p) => { 
                const f = document.getElementById('form-project'); f.reset();
                if(p) { 
                    ['id','title','regional','leader','theme','event_date','location'].forEach(k => document.getElementById('project-'+k).value = p[k]);
                    document.getElementById('project-status').value = p.status || 'Tahap 1: Submit Proposal';
                    document.getElementById('modal-project-title').innerText = "Edit Proyek";
                } else { document.getElementById('project-id').value = ""; document.getElementById('modal-project-title').innerText = "Proyek Baru"; }
                app.toggleModal('modal-project');
            },
            openGeneric: (title, html, handler) => { document.getElementById('modal-generic-title').innerText=title; document.getElementById('modal-generic-content').innerHTML=html; document.querySelector('#modal-generic-content form').onsubmit=handler; app.toggleModal('modal-generic'); },
            openRundownModal: (i) => app.openGeneric(i?"Edit Rundown":"Tambah", `<form class="space-y-3"><input type="hidden" name="id" value="${i?.id||''}"><input type="hidden" name="project_id" value="${app.activeProjectId}"><div class="flex gap-2"><input class="border rounded p-2 w-full" name="time_start" placeholder="Start" value="${i?.time_start||''}"><input class="border rounded p-2 w-full" name="time_end" placeholder="End" value="${i?.time_end||''}"></div><input class="border rounded p-2 w-full" name="activity" placeholder="Kegiatan" value="${i?.activity||''}" required><textarea class="border rounded p-2 w-full" name="description" placeholder="Ket">${i?.description||''}</textarea><button class="bg-green-600 text-white w-full py-2 rounded font-bold">Simpan</button></form>`, (e)=>{e.preventDefault(); app.handleFormSubmit(e.target,'rundowns')}),
            openBudgetModal: (i) => app.openGeneric(i?"Edit Budget":"Tambah", `<form class="space-y-3"><input type="hidden" name="id" value="${i?.id||''}"><input type="hidden" name="project_id" value="${app.activeProjectId}"><input class="border rounded p-2 w-full" name="item_name" placeholder="Item" value="${i?.item_name||''}" required><div class="flex gap-2"><input class="border rounded p-2 w-full" name="quantity" id="bq" placeholder="Qty" value="${i?.quantity||''}"><input class="border rounded p-2 w-full" name="unit_price" id="bp" placeholder="Harga" value="${i?.unit_price||''}"></div><input class="border rounded p-2 w-full bg-slate-50" name="total_price" id="bt" placeholder="Total" value="${i?.total_price||''}"><button class="bg-green-600 text-white w-full py-2 rounded font-bold">Simpan</button></form>`, (e)=>{e.preventDefault(); app.handleFormSubmit(e.target,'budgets')}),
            openVolunteerModal: (i) => app.openGeneric(i?"Edit Divisi":"Tambah", `<form class="space-y-3"><input type="hidden" name="id" value="${i?.id||''}"><input type="hidden" name="project_id" value="${app.activeProjectId}"><div class="flex gap-2"><input class="border rounded p-2 w-full" name="role_name" placeholder="Divisi" value="${i?.role_name||''}" required><input class="border rounded p-2 w-20" name="count" placeholder="Jml" value="${i?.count||''}"></div><button class="bg-green-600 text-white w-full py-2 rounded font-bold">Simpan</button></form>`, (e)=>{e.preventDefault(); app.handleFormSubmit(e.target,'volunteers')}),
            
            showToast: (m) => { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; t.classList.remove('translate-x-full'); setTimeout(()=>t.classList.add('translate-x-full'),3000); },
            formatCurrency: (n) => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n),
            formatDate: (s) => s ? new Date(s).toLocaleDateString('id-ID',{day:'numeric',month:'short',year:'numeric'}) : '-',
            generateBandungData: async () => {
                if(!confirm("Generate data?")) return;
                const { data: p } = await supabase.from('projects').insert([{title:"Bandung Menyapa #3",regional:"Bandung",theme:"Charity",leader:"Shafira",event_date:"2025-12-21",location:"Bandung",status:"Tahap 3: Rekrutmen & Pembelian"}]).select().single();
                if(p) {
                     await supabase.from('rundowns').insert([{project_id:p.id,time_start:"08:00",time_end:"09:00",activity:"Opening"}]);
                     await supabase.from('budgets').insert([{project_id:p.id,item_name:"Konsumsi",quantity:"50",unit_price:20000,total_price:1000000}]);
                     app.showToast("Done!"); app.fetchProjects(); app.showPage('projects');
                }
            }
        };

        app.init();
        
        // Auto calc budget hook
        document.addEventListener('input', (e) => {
            if(e.target.id === 'bq' || e.target.id === 'bp') {
                const q = parseFloat(document.getElementById('bq').value)||0;
                const p = parseFloat(document.getElementById('bp').value)||0;
                document.getElementById('bt').value = q*p;
            }
        });
    </script>
</body>
</html>
