<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sankara NGO Project Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loading-spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #16a34a; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .page-transition { transition: all 0.3s ease-in-out; }
        
        /* Sidebar active state */
        .sidebar-item { transition: all 0.2s ease; }
        .sidebar-item.active {
            background-color: #f0fdf4; color: #059669;
            box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.1); border: 1px solid #bbf7d0;
        }
        .status-badge { @apply px-3 py-1 rounded-full text-xs font-bold border; }
        .status-pending { @apply bg-yellow-100 text-yellow-800 border-yellow-200; }
        .status-submitted { @apply bg-blue-100 text-blue-800 border-blue-200; }
        .status-approved { @apply bg-green-100 text-green-800 border-green-200; }
        .status-rejected { @apply bg-red-100 text-red-800 border-red-200; }
        .step-locked { opacity: 0.6; cursor: not-allowed; }
        .step-unlocked { cursor: pointer; }
        
        /* Gantt Chart Styles */
        .gantt-bar { transition: all 0.3s ease; }
        .timeline-milestone { position: relative; }
        .timeline-milestone::before { content: ''; position: absolute; left: -8px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; border-radius: 50%; background: #16a34a; }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen flex overflow-hidden">
    
    <!-- 1. NOTIFICATIONS & MODALS (GLOBAL) -->
    
    <!-- Toast -->
    <div id="toast" class="fixed top-5 right-5 z-50 transform transition-transform translate-x-full duration-300">
        <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-xl p-4 flex items-center pr-8">
            <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
            <div><h4 class="font-bold text-sm text-gray-800">Notifikasi</h4><span id="toast-msg" class="text-sm text-gray-600">Message</span></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Login Admin</h3>
                <button onclick="Core.toggleModal('login-modal')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <form id="login-form" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Email Admin</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-3 border rounded-xl" placeholder="admin@sankara.org">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-3 border rounded-xl" placeholder="admin123">
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">Masuk</button>
                <div class="text-xs text-slate-500 text-center mt-4">Demo: admin@sankara.org / admin123</div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="modal-project" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-white px-6 py-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Proyek Baru</h3>
                <button onclick="Core.toggleModal('modal-project')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <form id="form-project" class="p-6 space-y-4">
                <input type="hidden" name="id" id="project-id">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">NAMA KEGIATAN</label><input type="text" name="title" required class="w-full border rounded-lg px-3 py-2"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">REGIONAL</label>
                        <select name="regional" id="regional-select" required class="w-full border rounded-lg px-3 py-2">
                            <option value="">Pilih Regional</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">LEADER</label><input type="text" name="leader" class="w-full border rounded-lg px-3 py-2"></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">TEMA</label><input type="text" name="theme" class="w-full border rounded-lg px-3 py-2"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">TANGGAL</label><input type="date" name="event_date" required class="w-full border rounded-lg px-3 py-2"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">LOKASI</label><input type="text" name="location" class="w-full border rounded-lg px-3 py-2"></div>
                </div>
                <input type="hidden" name="status" value="Tahap 1: Submit Proposal">
                <input type="hidden" name="finance_status" value="Belum Diajukan">
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">Simpan Proyek</button>
            </form>
        </div>
    </div>

    <!-- Generic Modal (Used for dynamic content) -->
    <div id="modal-generic" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800" id="modal-generic-title">Modal</h3>
                <button onclick="Core.toggleModal('modal-generic')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-generic-content" class="p-6"></div>
        </div>
    </div>

    <!-- 2. LAYOUT STRUCTURE -->
    
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col z-20">
        <div class="p-6 flex items-center border-b border-slate-100">
            <div class="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center text-white font-bold mr-3 shadow-green-200 shadow-lg">S</div>
            <h1 class="text-xl font-bold text-slate-800">SANKARA <span class="text-green-600">PM</span></h1>
        </div>
        
        <!-- User Info Badge -->
        <div class="p-4 border-b border-slate-100">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-user"></i></div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-slate-800 truncate" id="sidebar-username">Guest User</p>
                    <p class="text-xs text-slate-500" id="sidebar-role">Mode Tamu</p>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-1">
            <button id="nav-dashboard" onclick="App.router('dashboard')" class="w-full text-left px-4 py-3 rounded-xl sidebar-item text-slate-600 hover:bg-green-50 font-medium flex items-center group">
                <i class="fas fa-chart-pie w-6 text-slate-400 group-hover:text-green-600"></i> Dashboard
            </button>
            <button id="nav-projects" onclick="App.router('projects')" class="w-full text-left px-4 py-3 rounded-xl sidebar-item text-slate-600 hover:bg-green-50 font-medium flex items-center group">
                <i class="fas fa-layer-group w-6 text-slate-400 group-hover:text-green-600"></i> Manajemen Proyek
            </button>
            
            <!-- Admin Only Section -->
            <div id="admin-menu-section" class="hidden mt-6">
                <div class="px-4 py-2 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Admin Area</div>
                <button id="nav-approvals" onclick="App.router('approvals')" class="w-full text-left px-4 py-3 rounded-xl sidebar-item text-slate-600 hover:bg-blue-50 font-medium flex items-center group">
                    <i class="fas fa-check-circle w-6 text-slate-400 group-hover:text-blue-600"></i> Approval Proyek
                </button>
                <button id="nav-users" onclick="App.router('users')" class="w-full text-left px-4 py-3 rounded-xl sidebar-item text-slate-600 hover:bg-purple-50 font-medium flex items-center group">
                    <i class="fas fa-users w-6 text-slate-400 group-hover:text-purple-600"></i> Manajemen User
                </button>
            </div>
        </nav>
        
        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <button id="btn-login-sidebar" onclick="Core.toggleModal('login-modal')" class="w-full flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 transition font-medium">
                <i class="fas fa-sign-in-alt mr-2"></i> Login Admin
            </button>
            <button id="btn-logout-sidebar" onclick="Auth.logout()" class="w-full hidden items-center justify-center px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-xl hover:bg-slate-50 transition font-medium">
                <i class="fas fa-sign-out-alt mr-2"></i> Logout
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <!-- Header -->
        <header class="bg-white border-b p-4 flex justify-between items-center shadow-sm z-20">
            <div class="font-bold text-green-700 flex items-center gap-2">
                <span class="md:hidden">SANKARA PM</span>
                <span class="hidden md:inline">SANKARA PROJECT MANAGEMENT SYSTEM</span>
            </div>
            <div class="flex items-center gap-4">
                <div id="admin-badge" class="hidden">
                    <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-bold border border-purple-200"><i class="fas fa-crown mr-1"></i> Admin</span>
                </div>
                <button onclick="Core.toggleModal('login-modal')" id="header-login-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold md:hidden">Login</button>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth custom-scrollbar">
            <!-- Content injected by JS -->
        </div>
    </main>

    <!-- 3. JAVASCRIPT LOGIC (MODULARIZED) -->
    <script>
        // --- MODULE 1: CORE & CONFIG ---
        const Core = {
            supabase: null,
            SOP_STEPS: [
                { id: 1, name: "Submit Proposal", desc: "H-18", fullStatus: "Tahap 1: Submit Proposal", nextStatus: "Tahap 2: Media & Finance", requiresApproval: true },
                { id: 2, name: "Media & Finance", desc: "H-15", fullStatus: "Tahap 2: Media & Finance", nextStatus: "Tahap 3: Rekrutmen & Pembelian", requiresApproval: true },
                { id: 3, name: "Rekrutmen & Pembelian", desc: "H-15 s/d H-5", fullStatus: "Tahap 3: Rekrutmen & Pembelian", nextStatus: "Tahap 4: First Meet", requiresApproval: true }, // MODIFIKASI: requiresApproval: true
                { id: 4, name: "First Meet", desc: "H-3", fullStatus: "Tahap 4: First Meet", nextStatus: "Tahap 5: Kegiatan", requiresApproval: false },
                { id: 5, name: "Kegiatan", desc: "H-0", fullStatus: "Tahap 5: Kegiatan", nextStatus: "Tahap 6: Laporan", requiresApproval: false },
                { id: 6, name: "Laporan", desc: "H+2", fullStatus: "Tahap 6: Laporan", nextStatus: "Tahap 6: Laporan - Selesai", requiresApproval: true }
            ],
            APPROVAL_STATUS: { PENDING: 'pending', SUBMITTED: 'submitted', APPROVED: 'approved', REJECTED: 'rejected' },
            FINANCE_STATUS: { PENDING: 'Belum Diajukan', SUBMITTED: 'Diajukan', ACCEPTED: 'Diterima', REJECTED: 'Ditolak' },

            initSupabase: () => {
                const SUPABASE_URL = 'https://ruehfvjwdasqpzmroaau.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1ZWhmdmp3ZGFzcXB6bXJvYWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MjAwMzgsImV4cCI6MjA3OTk5NjAzOH0.T96V7eHlNpBDV6yIJN1WbFXXb8LUYbA3yWDloY_jya8';
                Core.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            },

            formatDate: (s) => s ? new Date(s).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'}) : '-',
            formatCurrency: (n) => n ? new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n) : 'Rp 0',
            
            showToast: (msg) => {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').textContent = msg;
                t.classList.remove('translate-x-full');
                setTimeout(() => t.classList.add('translate-x-full'), 3000);
            },

            toggleModal: (id) => document.getElementById(id).classList.toggle('hidden'),

            openGenericModal: (title, html, onSubmitFn) => {
                document.getElementById('modal-generic-title').innerText = title;
                document.getElementById('modal-generic-content').innerHTML = html;
                if(onSubmitFn) document.querySelector('#modal-generic-content form').onsubmit = onSubmitFn;
                Core.toggleModal('modal-generic');
            },

            fetchRegions: async () => {
                try {
                    const { data, error } = await Core.supabase.from('regions').select('*').order('name');
                    const regions = data || [{name:'Bandung'},{name:'Jakarta'},{name:'Surabaya'},{name:'Yogyakarta'}]; // Fallback
                    const select = document.getElementById('regional-select');
                    if (select) select.innerHTML = '<option value="">Pilih Regional</option>' + regions.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
                    return regions;
                } catch(e) { console.error(e); return []; }
            }
        };

        // --- MODULE 2: AUTHENTICATION ---
        const Auth = {
            currentUser: null,
            
            init: () => {
                const saved = localStorage.getItem('sankara_admin');
                if (saved) {
                    Auth.currentUser = JSON.parse(saved);
                    Auth.updateUI(true);
                } else {
                    Auth.updateUI(false);
                }
                
                document.getElementById('login-form').addEventListener('submit', Auth.handleLogin);
            },

            handleLogin: async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                // Demo logic (Replace with Supabase auth in prod)
                if (email === 'admin@sankara.org' && password === 'admin123') {
                    Auth.currentUser = { name: 'Admin Sankara', email: email, role: 'admin', regional: 'All' };
                    localStorage.setItem('sankara_admin', JSON.stringify(Auth.currentUser));
                    Auth.updateUI(true);
                    Core.toggleModal('login-modal');
                    Core.showToast('Login berhasil!');
                    App.router('dashboard');
                } else {
                    Core.showToast('Email atau password salah');
                }
            },

            logout: () => {
                localStorage.removeItem('sankara_admin');
                Auth.currentUser = null;
                Auth.updateUI(false);
                Core.showToast('Logout berhasil');
                App.router('projects');
            },

            isAdmin: () => Auth.currentUser && Auth.currentUser.role === 'admin',

            updateUI: (isLoggedIn) => {
                const user = Auth.currentUser;
                document.getElementById('sidebar-username').textContent = isLoggedIn ? user.name : 'Guest User';
                document.getElementById('sidebar-role').textContent = isLoggedIn ? 'Administrator' : 'Mode Tamu';
                
                const show = (id) => document.getElementById(id)?.classList.remove('hidden');
                const hide = (id) => document.getElementById(id)?.classList.add('hidden');

                if (isLoggedIn) {
                    hide('btn-login-sidebar'); show('btn-logout-sidebar');
                    show('admin-menu-section'); show('admin-badge');
                    hide('header-login-btn');
                } else {
                    show('btn-login-sidebar'); hide('btn-logout-sidebar');
                    hide('admin-menu-section'); hide('admin-badge');
                    show('header-login-btn');
                }
            }
        };

        // --- MODULE 3: USER VIEWS (Dashboard, Projects) ---
        const UserModule = {
            projects: [],
            activeProjectId: null,
            filterRegion: 'all',

            loadData: async () => {
                const { data } = await Core.supabase.from('projects').select('*').order('event_date');
                UserModule.projects = data || [];
            },

            renderDashboard: async (container) => {
                const total = UserModule.projects.length;
                const done = UserModule.projects.filter(p => p.status && p.status.includes('Tahap 6') && p.status.includes('Selesai')).length;
                const progress = total - done;

                container.innerHTML = `
                    <div class="fade-in">
                        <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-xl border shadow-sm flex flex-col items-center">
                                <span class="text-3xl font-bold text-slate-800">${total}</span>
                                <span class="text-sm text-slate-500">Total Proyek</span>
                            </div>
                            <div class="bg-white p-6 rounded-xl border shadow-sm flex flex-col items-center text-green-600">
                                <span class="text-3xl font-bold">${done}</span>
                                <span class="text-sm">Selesai</span>
                            </div>
                            <div class="bg-white p-6 rounded-xl border shadow-sm flex flex-col items-center text-blue-600">
                                <span class="text-3xl font-bold">${progress}</span>
                                <span class="text-sm">Dalam Proses</span>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl border shadow-sm p-6 mb-8">
                            <h3 class="font-bold text-lg mb-4">Gantt Chart Utama</h3>
                            <div class="overflow-x-auto">
                                ${UserModule.renderGanttChart(UserModule.projects)}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderProjectList: async (container) => {
                const filtered = UserModule.filterRegion === 'all' 
                    ? UserModule.projects 
                    : UserModule.projects.filter(p => p.regional === UserModule.filterRegion);

                const regions = await Core.fetchRegions(); 

                container.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                            <h2 class="text-2xl font-bold">Daftar Proyek</h2>
                            <div class="flex gap-2">
                                <select onchange="UserModule.filterRegion=this.value; App.router('projects')" class="border rounded-lg px-3 py-2 text-sm">
                                    <option value="all">Semua Regional</option>
                                    ${regions.map(r => `<option value="${r.name}" ${UserModule.filterRegion===r.name?'selected':''}>${r.name}</option>`).join('')}
                                </select>
                                <button onclick="Core.toggleModal('modal-project')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm">+ Buat Proyek</button>
                            </div>
                        </div>
                        <div class="grid gap-4">
                            ${filtered.length === 0 ? '<div class="p-8 text-center text-slate-500 bg-white rounded-xl border">Belum ada data proyek</div>' : ''}
                            ${filtered.map(p => `
                                <div onclick="UserModule.openProjectDetail('${p.id}')" class="bg-white p-5 rounded-xl border shadow-sm hover:shadow-md cursor-pointer transition relative group">
                                    <div class="absolute top-4 right-4 z-10">
                                        <button onclick="event.stopPropagation(); UserModule.deleteProject('${p.id}')" class="bg-white text-slate-300 hover:text-red-600 p-2 rounded-full shadow-sm hover:shadow transition"><i class="fas fa-trash"></i></button>
                                    </div>
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="bg-slate-800 text-white text-xs px-2 py-1 rounded">${p.regional || 'N/A'}</span>
                                        <span class="text-xs text-slate-500">${Core.formatDate(p.event_date)}</span>
                                    </div>
                                    <h3 class="font-bold text-lg mb-1">${p.title}</h3>
                                    <div class="text-sm text-slate-500 mb-2">${p.status}</div>
                                    <div class="text-xs text-slate-400"><i class="fas fa-user mr-1"></i> ${p.leader || '-'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            openProjectDetail: async (id, stepId = 1) => {
                UserModule.activeProjectId = id;
                const container = document.getElementById('content-area');
                container.innerHTML = '<div class="flex h-full items-center justify-center"><div class="loading-spinner"></div></div>';
                
                const { data: project } = await Core.supabase.from('projects').select('*').eq('id', id).single();
                if(!project) return App.router('projects');

                const [rundowns, budgets, volunteers, approvals] = await Promise.all([
                    Core.supabase.from('rundowns').select('*').eq('project_id', id),
                    Core.supabase.from('budgets').select('*').eq('project_id', id),
                    Core.supabase.from('volunteers').select('*').eq('project_id', id),
                    Core.supabase.from('project_approvals').select('*').eq('project_id', id)
                ]);

                UserModule.renderDetailView(container, project, {
                    rundowns: rundowns.data, budgets: budgets.data, volunteers: volunteers.data, approvals: approvals.data
                }, stepId);
            },

            renderDetailView: (container, project, relations, activeStep) => {
                const getStepStatus = (stepNum) => {
                    const app = relations.approvals.find(a => a.step_number === stepNum);
                    return app ? app.status : 'pending';
                };

                const stepsHtml = Core.SOP_STEPS.map(step => {
                    const status = getStepStatus(step.id);
                    const isActive = activeStep === step.id;
                    // Logic penguncian step: User bisa klik step jika step sebelumnya 'approved' ATAU step 1 (selalu buka)
                    // Namun untuk admin, semua step mungkin bisa dilihat. 
                    // Disini kita buat sederhana: step sebelumnya harus approved untuk akses step berikutnya.
                    
                    let color = isActive ? 'bg-green-600 text-white' : 'bg-white text-slate-600 border-slate-200';
                    let icon = status === 'approved' ? 'fa-check text-green-500' : status === 'rejected' ? 'fa-times text-red-500' : 'fa-circle text-slate-300';
                    
                    // Logic Step Locking (Simplified)
                    let prevStepStatus = step.id === 1 ? 'approved' : getStepStatus(step.id - 1);
                    let isLocked = prevStepStatus !== 'approved' && step.id > 1;
                    
                    if (isLocked) color += ' opacity-50 cursor-not-allowed';

                    return `
                        <button onclick="${isLocked ? '' : `UserModule.openProjectDetail('${project.id}', ${step.id})`}" class="flex flex-col items-center min-w-[100px] p-2 rounded-xl border transition relative ${color} mx-1">
                            <div class="text-xs font-bold">Tahap ${step.id}</div>
                            <div class="text-[10px] text-center">${step.name}</div>
                            <i class="fas ${icon} text-xs absolute -top-1 -right-1 bg-white rounded-full p-1 border"></i>
                        </button>
                    `;
                }).join('');

                let contentHtml = UserModule.getStepContent(activeStep, project, relations);

                container.innerHTML = `
                    <div class="fade-in pb-10">
                        <button onclick="App.router('projects')" class="text-sm text-slate-500 hover:text-green-600 mb-4"><i class="fas fa-arrow-left"></i> Kembali</button>
                        <h1 class="text-2xl font-bold text-slate-800 mb-1">${project.title}</h1>
                        <p class="text-sm text-slate-500 mb-6">${project.regional} â€¢ ${Core.formatDate(project.event_date)}</p>
                        
                        <div class="flex overflow-x-auto pb-4 mb-4">${stepsHtml}</div>
                        
                        <div class="bg-white rounded-2xl p-6 border shadow-sm relative mb-6">
                            ${contentHtml}
                        </div>

                        <div class="bg-white rounded-2xl border shadow-sm p-6">
                            <h3 class="font-bold text-lg mb-4">Timeline Per Event</h3>
                            <div class="overflow-x-auto">
                                ${UserModule.renderGanttChart([project])}
                            </div>
                        </div>
                    </div>
                `;
            },

            getStepContent: (stepId, p, r) => {
                const status = r.approvals.find(a => a.step_number === stepId)?.status || 'pending';
                const isAdmin = Auth.isAdmin();
                const stepConfig = Core.SOP_STEPS.find(s => s.id === stepId);
                
                let controls = '';
                
                // Logic Tombol Approval (Berlaku untuk Step 1, 2, 3, 6 yang requiresApproval=true)
                if (stepConfig.requiresApproval) {
                    if (status === 'pending') {
                        controls = `<button onclick="UserModule.submitApproval('${p.id}', ${stepId})" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm w-full shadow-lg shadow-blue-200">Ajukan Approval</button>`;
                    } else if (status === 'submitted') {
                        controls = `<div class="bg-yellow-50 text-yellow-800 p-3 rounded-lg text-sm text-center border border-yellow-100">Menunggu Persetujuan Admin</div>`;
                        if (isAdmin) {
                            controls += `
                                <div class="flex gap-2 mt-2">
                                    <button onclick="AdminModule.decide('${p.id}', ${stepId}, 'approved')" class="bg-green-600 text-white flex-1 py-2 rounded font-bold text-sm">Approve</button>
                                    <button onclick="AdminModule.decide('${p.id}', ${stepId}, 'rejected')" class="bg-red-600 text-white flex-1 py-2 rounded font-bold text-sm">Reject</button>
                                </div>
                            `;
                        }
                    } else if (status === 'approved') {
                        controls = `<div class="bg-green-50 text-green-800 p-3 rounded-lg text-sm text-center font-bold border border-green-100"><i class="fas fa-check-circle"></i> Tahap Disetujui</div>`;
                        // Auto-Next Button jika ingin manual
                        if (stepId < 6) {
                             controls += `<button onclick="UserModule.openProjectDetail('${p.id}', ${stepId+1})" class="mt-2 w-full bg-slate-100 text-slate-600 py-2 rounded font-bold text-sm">Lanjut ke Tahap ${stepId+1}</button>`;
                        }
                    } else if (status === 'rejected') {
                        controls = `
                            <div class="bg-red-50 text-red-800 p-3 rounded-lg text-sm text-center mb-2 border border-red-100">Ditolak. Silakan perbaiki dan ajukan ulang.</div>
                            <button onclick="UserModule.submitApproval('${p.id}', ${stepId})" class="bg-slate-600 text-white px-4 py-2 rounded-lg font-bold text-sm w-full">Ajukan Ulang</button>
                        `;
                    }
                } else {
                    // Step tanpa approval (First Meet, Kegiatan)
                    controls = `<button onclick="UserModule.openProjectDetail('${p.id}', ${stepId+1})" class="bg-teal-600 text-white px-4 py-2 rounded-lg font-bold text-sm w-full">Selesai, Lanjut Tahap Berikutnya</button>`;
                }

                // Dynamic forms based on step
                let body = '';
                if(stepId === 1) {
                    body = `
                        <label class="block text-xs font-bold text-slate-500 mb-1">TARGET AUDIENCE</label>
                        <input value="${p.target_audience||''}" onchange="UserModule.updateField('${p.id}','target_audience',this.value)" class="w-full border p-2 rounded mb-4" placeholder="Nama Panti / Yayasan">
                        <label class="block text-xs font-bold text-slate-500 mb-1">KONSEP ACARA</label>
                        <textarea onchange="UserModule.updateField('${p.id}','concept_note',this.value)" class="w-full border p-2 rounded" rows="4" placeholder="Deskripsi konsep acara...">${p.concept_note||''}</textarea>
                    `;
                } else if (stepId === 2) {
                    const total = r.budgets.reduce((a,b) => a + (b.total_price||0), 0);
                    body = `
                        <!-- RAB Section -->
                        <div class="flex justify-between items-center mb-2"><h4 class="font-bold text-slate-700">Rencana Anggaran (RAB)</h4> <button onclick="UserModule.addItemModal('budgets', '${p.id}')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold">+ Item Budget</button></div>
                        <div class="bg-slate-50 p-3 rounded-xl border mb-6 text-sm space-y-2">
                            ${r.budgets.length === 0 ? '<div class="text-center text-slate-400 italic">Belum ada data anggaran</div>' : ''}
                            ${r.budgets.map(b => `<div class="flex justify-between border-b pb-1 last:border-0"><span>${b.item_name} (${b.quantity})</span><span class="font-bold">${Core.formatCurrency(b.total_price)}</span></div>`).join('')}
                            <div class="flex justify-between font-bold pt-2 border-t mt-2 text-blue-700"><span>Total</span><span>${Core.formatCurrency(total)}</span></div>
                        </div>

                        <!-- Rundown Section (Dikembalikan) -->
                        <div class="flex justify-between items-center mb-2"><h4 class="font-bold text-slate-700">Rundown Acara</h4> <button onclick="UserModule.openRundownModal('${p.id}')" class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded font-bold">+ Kegiatan</button></div>
                        <div class="bg-slate-50 p-3 rounded-xl border mb-6 text-sm space-y-2">
                            ${r.rundowns.length === 0 ? '<div class="text-center text-slate-400 italic">Belum ada rundown</div>' : ''}
                            ${r.rundowns.map(rd => `<div class="flex gap-3 border-b pb-1 last:border-0"><span class="font-mono bg-white px-1 rounded border text-xs h-fit">${rd.time_start}-${rd.time_end}</span><span>${rd.activity}</span></div>`).join('')}
                        </div>

                        <!-- Media Section -->
                        <label class="block text-xs font-bold text-slate-500 mb-1">LINK POSTER / PUBLIKASI</label>
                        <input value="${p.poster_link||''}" onchange="UserModule.updateField('${p.id}','poster_link',this.value)" class="w-full border p-2 rounded" placeholder="https://instagram.com/...">
                    `;
                } else if (stepId === 3) {
                    body = `
                        <div class="flex justify-between items-center mb-2"><h4 class="font-bold text-slate-700">Divisi & Relawan</h4> <button onclick="UserModule.addItemModal('volunteers', '${p.id}')" class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded font-bold">+ Divisi</button></div>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            ${r.volunteers.map(v => `<div class="bg-slate-50 p-2 rounded border text-sm flex justify-between"><span>${v.role_name}</span><span class="font-bold">${v.count}</span></div>`).join('')}
                        </div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">STATUS PEMBELIAN LOGISTIK</label>
                        <select onchange="UserModule.updateField('${p.id}','purchase_status',this.value)" class="w-full border p-2 rounded mb-2">
                            <option value="Belum Dimulai" ${p.purchase_status==='Belum Dimulai'?'selected':''}>Belum Dimulai</option>
                            <option value="Dalam Proses" ${p.purchase_status==='Dalam Proses'?'selected':''}>Dalam Proses</option>
                            <option value="Selesai" ${p.purchase_status==='Selesai'?'selected':''}>Selesai</option>
                        </select>
                    `;
                } else if (stepId === 4) {
                    body = `
                        <label class="block text-xs font-bold text-slate-500 mb-1">CATATAN FIRST MEET</label>
                        <textarea onchange="UserModule.updateField('${p.id}','firstmeet_notes',this.value)" class="w-full border p-2 rounded" rows="5" placeholder="Hasil diskusi first meet...">${p.firstmeet_notes||''}</textarea>
                    `;
                } else if (stepId === 5) {
                    body = `
                        <div class="bg-blue-50 p-4 rounded-xl text-center mb-4">
                            <h4 class="font-bold text-blue-800">Event Day (H-0)</h4>
                            <p class="text-sm text-blue-600">Pastikan dokumentasi kegiatan berjalan dengan baik.</p>
                        </div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">CATATAN EVALUASI EVENT</label>
                        <textarea onchange="UserModule.updateField('${p.id}','eventday_notes',this.value)" class="w-full border p-2 rounded" rows="5">${p.eventday_notes||''}</textarea>
                    `;
                } else if (stepId === 6) {
                     body = `
                        <label class="block text-xs font-bold text-slate-500 mb-1">ISI LAPORAN / LINK DRIVE</label>
                        <textarea onchange="UserModule.updateField('${p.id}','report_content',this.value)" class="w-full border p-2 rounded mb-4" rows="5">${p.report_content||''}</textarea>
                        ${status === 'approved' ? `<button onclick="PDFService.generate('${p.id}')" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition"><i class="fas fa-file-pdf mr-2"></i> Download Laporan PDF</button>` : ''}
                     `;
                }

                return `
                    <div class="mb-4">${body}</div>
                    <div class="mt-4 pt-4 border-t">${controls}</div>
                `;
            },

            updateField: async (id, field, val) => {
                await Core.supabase.from('projects').update({[field]: val}).eq('id', id);
                Core.showToast('Data tersimpan');
            },

            submitApproval: async (id, step) => {
                await Core.supabase.from('project_approvals').upsert({ project_id: id, step_number: step, status: 'submitted', submitted_at: new Date() });
                Core.showToast('Approval diajukan');
                UserModule.openProjectDetail(id, step);
            },

            addItemModal: (table, pid) => {
                const title = table === 'budgets' ? 'Tambah Budget' : 'Tambah Divisi Relawan';
                const fields = table === 'budgets' 
                    ? `<input name="item_name" placeholder="Nama Item" class="w-full border p-2 rounded mb-2" required>
                       <div class="flex gap-2 mb-2">
                           <input name="quantity" type="number" placeholder="Qty" class="w-full border p-2 rounded" oninput="document.getElementById('tot').value = this.value * document.getElementById('prc').value">
                           <input name="unit_price" id="prc" type="number" placeholder="Harga" class="w-full border p-2 rounded" oninput="document.getElementById('tot').value = this.value * document.getElementsByName('quantity')[0].value">
                       </div>
                       <input name="total_price" id="tot" readonly class="w-full border p-2 rounded bg-slate-100 mb-4">`
                    : `<input name="role_name" placeholder="Nama Divisi" class="w-full border p-2 rounded mb-2" required>
                       <input name="count" type="number" placeholder="Jumlah Orang" class="w-full border p-2 rounded mb-4">`;

                const html = `
                    <form onsubmit="event.preventDefault(); UserModule.saveItem('${table}', '${pid}', this)">
                        ${fields}
                        <button class="w-full bg-green-600 text-white py-2 rounded font-bold">Simpan</button>
                    </form>
                `;
                Core.openGenericModal(title, html);
            },

            openRundownModal: (pid) => {
                const html = `
                    <form onsubmit="event.preventDefault(); UserModule.saveItem('rundowns', '${pid}', this)">
                        <div class="flex gap-2 mb-2">
                            <input name="time_start" placeholder="Mulai (08:00)" class="w-full border p-2 rounded" required>
                            <input name="time_end" placeholder="Selesai (09:00)" class="w-full border p-2 rounded" required>
                        </div>
                        <input name="activity" placeholder="Nama Kegiatan" class="w-full border p-2 rounded mb-4" required>
                        <button class="w-full bg-green-600 text-white py-2 rounded font-bold">Simpan Rundown</button>
                    </form>
                `;
                Core.openGenericModal('Tambah Rundown', html);
            },

            saveItem: async (table, pid, form) => {
                const fd = new FormData(form);
                const d = Object.fromEntries(fd);
                d.project_id = pid;
                await Core.supabase.from(table).insert(d);
                Core.toggleModal('modal-generic');
                UserModule.openProjectDetail(pid, table === 'rundowns' || table === 'budgets' ? 2 : 3);
            },
            
            deleteProject: async (id) => {
                if(!confirm('Hapus proyek?')) return;
                // Delete related data first
                await Promise.all([
                    Core.supabase.from('rundowns').delete().eq('project_id', id),
                    Core.supabase.from('budgets').delete().eq('project_id', id),
                    Core.supabase.from('volunteers').delete().eq('project_id', id),
                    Core.supabase.from('project_approvals').delete().eq('project_id', id)
                ]);
                await Core.supabase.from('projects').delete().eq('id', id);
                UserModule.projects = UserModule.projects.filter(p => p.id !== id);
                App.router('projects');
                Core.showToast('Proyek dihapus');
            },

            renderGanttChart: (projectList) => {
                if (!projectList || projectList.length === 0) return '<div class="text-slate-400 text-sm italic">Tidak ada data untuk timeline</div>';

                // Gantt Chart Logic restoration
                // Calculates timeline based on project event_date relative to milestones
                // Milestones: H-18 (Prop), H-15 (Media), H-15 (Rekrut), H-3 (FirstMeet), H-0 (Event), H+2 (Laporan)
                
                const milestones = [
                    { name: "Prop", days: -18, color: "bg-slate-400" },
                    { name: "Media", days: -15, color: "bg-purple-400" },
                    { name: "Rekrut", days: -15, color: "bg-orange-400" },
                    { name: "FM", days: -3, color: "bg-yellow-500" },
                    { name: "Event", days: 0, color: "bg-blue-500" },
                    { name: "Lap", days: 2, color: "bg-green-500" }
                ];

                return `
                    <div class="min-w-[600px] text-sm">
                        ${projectList.map(p => {
                            if(!p.event_date) return '';
                            const eventDate = new Date(p.event_date);
                            const startDate = new Date(eventDate); startDate.setDate(startDate.getDate() - 20); // H-20
                            const totalRange = 25; // 20 days before + 5 days after

                            return `
                                <div class="mb-3 border-b pb-2">
                                    <div class="font-bold text-slate-700 mb-1 flex justify-between">
                                        <span>${p.title}</span>
                                        <span class="text-xs font-normal text-slate-500">${Core.formatDate(p.event_date)}</span>
                                    </div>
                                    <div class="relative h-6 bg-slate-100 rounded overflow-hidden">
                                        ${milestones.map(m => {
                                            // Simple positioning: (DayOffset + 20) / TotalRange * 100
                                            const pos = ((m.days + 20) / totalRange) * 100;
                                            return `<div class="absolute top-0 h-full w-4 ${m.color} text-[8px] text-white flex items-center justify-center rounded-sm" style="left: ${pos}%;" title="${m.name} (H${m.days})">${m.name[0]}</div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        <div class="flex gap-2 text-xs text-slate-500 mt-2">
                            <span class="flex items-center"><div class="w-2 h-2 bg-slate-400 mr-1"></div> Proposal</span>
                            <span class="flex items-center"><div class="w-2 h-2 bg-purple-400 mr-1"></div> Media</span>
                            <span class="flex items-center"><div class="w-2 h-2 bg-orange-400 mr-1"></div> Rekrutmen</span>
                            <span class="flex items-center"><div class="w-2 h-2 bg-yellow-500 mr-1"></div> First Meet</span>
                            <span class="flex items-center"><div class="w-2 h-2 bg-blue-500 mr-1"></div> Event</span>
                            <span class="flex items-center"><div class="w-2 h-2 bg-green-500 mr-1"></div> Laporan</span>
                        </div>
                    </div>
                `;
            }
        };

        // --- MODULE 4: ADMIN VIEWS ---
        const AdminModule = {
            renderApprovals: async (container) => {
                const { data: approvals } = await Core.supabase.from('project_approvals').select('*, projects(title, regional)').eq('status', 'submitted');
                
                container.innerHTML = `
                    <div class="fade-in">
                        <h2 class="text-2xl font-bold mb-6">Approval List</h2>
                        <div class="space-y-4">
                            ${(!approvals || approvals.length === 0) ? '<div class="p-6 bg-white rounded-xl text-center text-slate-500">Tidak ada approval pending</div>' : ''}
                            ${(approvals||[]).map(a => `
                                <div class="bg-white p-5 rounded-xl border border-yellow-200 shadow-sm">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="font-bold">${a.projects?.title || 'Unknown Project'}</h3>
                                        <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Step ${a.step_number}</span>
                                    </div>
                                    <p class="text-sm text-slate-500 mb-4">Regional: ${a.projects?.regional}</p>
                                    <div class="flex gap-2">
                                        <button onclick="AdminModule.decide('${a.project_id}', ${a.step_number}, 'approved')" class="bg-green-600 text-white px-4 py-2 rounded text-xs font-bold">Approve</button>
                                        <button onclick="AdminModule.decide('${a.project_id}', ${a.step_number}, 'rejected')" class="bg-red-600 text-white px-4 py-2 rounded text-xs font-bold">Reject</button>
                                        <button onclick="UserModule.openProjectDetail('${a.project_id}', ${a.step_number})" class="bg-slate-100 text-slate-600 px-4 py-2 rounded text-xs font-bold">Lihat Detail</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            decide: async (pid, step, decision) => {
                const update = { status: decision, notes: decision === 'rejected' ? 'Ditolak Admin' : '' };
                if (decision === 'approved') update.approved_at = new Date();
                
                await Core.supabase.from('project_approvals').update(update).match({project_id: pid, step_number: step});
                
                // Update project status text if approved
                if (decision === 'approved') {
                    const stepInfo = Core.SOP_STEPS.find(s => s.id === step);
                    if(stepInfo && stepInfo.nextStatus) {
                        await Core.supabase.from('projects').update({status: stepInfo.nextStatus}).eq('id', pid);
                    }
                }

                Core.showToast(`Step ${decision}`);
                // Refresh logic depends on where we are
                if (document.getElementById('nav-approvals').classList.contains('active')) {
                    App.router('approvals');
                } else {
                    UserModule.openProjectDetail(pid, step);
                }
            },

            renderUsers: (container) => {
                container.innerHTML = `
                    <div class="fade-in text-center py-20 bg-white rounded-xl border">
                        <i class="fas fa-users text-4xl text-slate-300 mb-4"></i>
                        <h3 class="text-lg font-bold text-slate-600">Manajemen User</h3>
                        <p class="text-slate-500">Fitur ini akan segera hadir.</p>
                    </div>
                `;
            }
        };

        // --- MODULE 5: PDF SERVICE ---
        const PDFService = {
            generate: async (pid) => {
                const { data: p } = await Core.supabase.from('projects').select('*').eq('id', pid).single();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(20);
                doc.setTextColor(5, 150, 105);
                doc.text(p.title, 105, 20, null, null, 'center');
                
                doc.setFontSize(12);
                doc.setTextColor(0,0,0);
                doc.text(`Regional: ${p.regional}`, 20, 40);
                doc.text(`Leader: ${p.leader}`, 20, 50);
                doc.text(`Tanggal: ${Core.formatDate(p.event_date)}`, 20, 60);

                doc.text("Laporan Resmi Sankara NGO. Proyek telah selesai.", 20, 80);
                
                doc.save(`Laporan_${p.title}.pdf`);
            }
        };

        // --- MODULE 6: MAIN APP CONTROLLER ---
        const App = {
            init: async () => {
                Core.initSupabase();
                Auth.init();
                
                // Sidebar highlighting logic
                const btns = document.querySelectorAll('.sidebar-item');
                btns.forEach(b => b.addEventListener('click', () => {
                    btns.forEach(x => x.classList.remove('active'));
                    b.classList.add('active');
                }));

                // Handle New Project Form
                document.getElementById('form-project').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const d = Object.fromEntries(fd);
                    delete d.id;
                    await Core.supabase.from('projects').insert(d);
                    Core.toggleModal('modal-project');
                    Core.showToast('Proyek Dibuat');
                    e.target.reset();
                    App.router('projects');
                });

                // Default route
                App.router('projects');
            },

            router: async (route) => {
                const container = document.getElementById('content-area');
                // Highlight sidebar
                document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
                const navBtn = document.getElementById(`nav-${route}`);
                if(navBtn) navBtn.classList.add('active');

                // Route logic
                if (route === 'dashboard') {
                    await UserModule.loadData();
                    UserModule.renderDashboard(container);
                } else if (route === 'projects') {
                    await UserModule.loadData();
                    UserModule.renderProjectList(container);
                } else if (route === 'approvals') {
                    if (!Auth.isAdmin()) return Core.showToast('Akses ditolak');
                    AdminModule.renderApprovals(container);
                } else if (route === 'users') {
                    if (!Auth.isAdmin()) return Core.showToast('Akses ditolak');
                    AdminModule.renderUsers(container);
                }
            }
        };

        // Start App
        document.addEventListener('DOMContentLoaded', App.init);

    </script>
</body>
</html>
