<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sankara NGO Project Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loading-spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #16a34a; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .gantt-cell:hover .gantt-tooltip { display: block; }
        .today-line {
            position: absolute; top: 0; bottom: 0; width: 2px; background-color: #ef4444; 
            z-index: 50; border-left: 1px dashed #ef4444; pointer-events: none;
        }
        .today-label {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; font-size: 10px; padding: 2px 4px; rounded: 4px;
            white-space: nowrap; z-index: 51;
        }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen flex overflow-hidden">
    
    <!-- Toast & Modals -->
    <div id="toast" class="fixed top-5 right-5 z-[70] transform transition-transform translate-x-full duration-300">
        <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-xl p-4 flex items-center pr-8">
            <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
            <div><h4 class="font-bold text-sm text-gray-800">Notifikasi</h4><span id="toast-msg" class="text-sm text-gray-600">Message</span></div>
        </div>
    </div>

    <!-- Generic Modal -->
    <div id="modal-generic" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden max-h-[90vh] flex flex-col">
            <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg text-slate-800" id="modal-generic-title">Modal</h3>
                <button onclick="Core.toggleModal('modal-generic')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-generic-content" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="modal-confirm" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fas fa-question"></i>
                </div>
                <h3 class="font-bold text-lg text-slate-800 mb-2">Konfirmasi</h3>
                <p class="text-sm text-slate-600 mb-6" id="modal-confirm-msg">Apakah Anda yakin?</p>
                <div class="flex justify-center gap-3">
                    <button id="btn-confirm-cancel" class="px-4 py-2 border rounded-xl text-slate-600 hover:bg-slate-50 transition font-medium">Batal</button>
                    <button id="btn-confirm-yes" class="px-4 py-2 bg-slate-800 text-white rounded-xl hover:bg-slate-900 transition font-bold">Ya, Lanjutkan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Layout -->
    <aside class="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col z-20 shadow-sm">
        <div class="p-6 flex items-center border-b border-slate-100">
            <div class="w-10 h-10 bg-green-600 rounded-xl flex items-center justify-center text-white font-bold mr-3 shadow-lg shadow-green-200 transform transition hover:scale-105">
                <i class="fas fa-hand-holding-heart text-xl"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800 leading-tight">SANKARA</h1>
                <span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded-full">Project Mgmt</span>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
            <button id="nav-dashboard" onclick="App.router('dashboard')" class="w-full text-left px-4 py-3 rounded-xl sidebar-item hover:bg-green-50 text-slate-600 flex items-center transition-all duration-200 group">
                <i class="fas fa-chart-pie w-8 text-slate-400 group-hover:text-green-600 transition-colors"></i> 
                <span class="font-medium">Dashboard</span>
            </button>
            <button id="nav-projects" onclick="App.router('projects')" class="w-full text-left px-4 py-3 rounded-xl sidebar-item hover:bg-green-50 text-slate-600 flex items-center transition-all duration-200 group">
                <i class="fas fa-layer-group w-8 text-slate-400 group-hover:text-green-600 transition-colors"></i> 
                <span class="font-medium">Proyek</span>
            </button>
            <button id="nav-references" onclick="App.router('references')" class="w-full text-left px-4 py-3 rounded-xl sidebar-item hover:bg-orange-50 text-slate-600 flex items-center transition-all duration-200 group">
                <i class="fas fa-shopping-bag w-8 text-slate-400 group-hover:text-orange-600 transition-colors"></i> 
                <span class="font-medium">Referensi Alat</span>
            </button>
        </nav>
        <div class="p-4 border-t text-xs text-center text-slate-400">
            &copy; 2025 Sankara Foundation
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <div class="h-1.5 w-full bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500 absolute top-0 left-0 z-30"></div>
        <header class="bg-white border-b p-4 flex justify-between items-center shadow-sm z-20">
            <div class="font-bold text-green-700 text-lg md:hidden flex items-center">
                <i class="fas fa-hand-holding-heart mr-2"></i>SANKARA PM
            </div>
            <div class="hidden md:block font-bold text-slate-800 text-sm tracking-wide uppercase">Project Management Workspace</div>
        </header>
        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth custom-scrollbar relative bg-slate-50/50"></div>
    </main>

    <script>
        // --- MODULE 1: CORE & CONFIG ---
        window.Core = {
            supabase: window.supabase.createClient('https://ljhcszzmuaourbwwozmf.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqaGNzenptdWFvdXJid3dvem1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjY4OTcsImV4cCI6MjA3OTg0Mjg5N30.SnitqGcGWVqBrGD5OOB5RasA6u1rDCqpuKir0gLG_b8'),
            SUPABASE_URL: 'https://ljhcszzmuaourbwwozmf.supabase.co', 
            
            SOP_STEPS: [
                { id: 1, name: "Submit Proposal", desc: "H-18", requiresApproval: false }, 
                { id: 2, name: "Media & Finance", desc: "H-15", requiresApproval: true },
                { id: 3, name: "Rekrutmen & Beli", desc: "H-15 s/d H-5", requiresApproval: false }, 
                { id: 4, name: "First Meet", desc: "H-3", requiresApproval: false },
                { id: 5, name: "Kegiatan", desc: "H-0", requiresApproval: false },
                { id: 6, name: "Laporan", desc: "H+2", requiresApproval: true }
            ],

            formatDate: (s) => s ? new Date(s).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'}) : '-',
            formatCurrency: (n) => n ? new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n) : 'Rp 0',
            
            showToast: (msg) => {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').textContent = msg;
                t.classList.remove('translate-x-full');
                setTimeout(() => t.classList.add('translate-x-full'), 3000);
            },

            toggleModal: (id) => document.getElementById(id).classList.toggle('hidden'),

            openGenericModal: (title, html, onSubmitFn) => {
                document.getElementById('modal-generic-title').innerText = title;
                document.getElementById('modal-generic-content').innerHTML = html;
                if(onSubmitFn) document.querySelector('#modal-generic-content form').onsubmit = onSubmitFn;
                Core.toggleModal('modal-generic');
            },

            confirm: (msg) => {
                return new Promise((resolve) => {
                    document.getElementById('modal-confirm-msg').textContent = msg;
                    document.getElementById('modal-confirm').classList.remove('hidden');
                    const yesBtn = document.getElementById('btn-confirm-yes');
                    const noBtn = document.getElementById('btn-confirm-cancel');
                    const newYes = yesBtn.cloneNode(true);
                    const newNo = noBtn.cloneNode(true);
                    yesBtn.parentNode.replaceChild(newYes, yesBtn);
                    noBtn.parentNode.replaceChild(newNo, noBtn);
                    
                    newYes.onclick = () => { document.getElementById('modal-confirm').classList.add('hidden'); resolve(true); };
                    newNo.onclick = () => { document.getElementById('modal-confirm').classList.add('hidden'); resolve(false); };
                });
            },

            fetchRegions: async () => {
                const { data, error } = await Core.supabase.from('pm_regions').select('*').order('name');
                return error ? [] : data;
            },

            checkDB: async () => {
                const { error } = await Core.supabase.from('projects').select('id').limit(1);
            }
        };

        // --- MODULE 2: USER VIEWS ---
        window.UserModule = {
            projects: [],
            activeProjectId: null,
            filterRegion: 'all',
            dashboardFilterRegion: 'all', 
            references: [],
            rabInputs: { delegates: 0, price: 0 }
        };

        // --- USER MODULE FUNCTIONS ---
        UserModule.loadData = async () => {
            const { data } = await Core.supabase
                .from('projects')
                .select('*, project_approvals(step_number, status, notes)')
                .order('event_date', { ascending: false }); // URUTKAN DARI MASA DEPAN KE MASA LALU (DESCENDING)
            UserModule.projects = data || [];
        };

        UserModule.loadReferences = async () => {
            const { data } = await Core.supabase.from('event_tools_references').select('*').order('product_name');
            UserModule.references = data || [];
        };

        // --- HELPER: Calculate Logic ---
        UserModule.calculateEffectiveStep = (p) => {
            const approvals = p.project_approvals || [];
            const step2 = approvals.find(a => a.step_number === 2);
            const step6 = approvals.find(a => a.step_number === 6);
            
            let dbStep = parseInt(p.step) || 1;
            let effectiveStep = 1;

            if (step6 && step6.status === 'approved') return 6;
            if (step2 && step2.status === 'approved') {
                return Math.max(3, Math.min(5, dbStep));
            } else if (step2 && step2.status === 'submitted') {
                return 2; 
            }
            return Math.min(2, dbStep);
        };

        UserModule.renderReferences = async (container) => {
            await UserModule.loadReferences();
            container.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Referensi Alat & Bahan</h2>
                        <button onclick="UserModule.addReferenceModal()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md transition">+ Tambah Referensi</button>
                    </div>
                    ${UserModule.references.length === 0 ? `<div class="bg-white p-10 text-center text-slate-500">Belum ada data.</div>` : `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">${UserModule.references.map(i=>`<div class="bg-white p-4 rounded border shadow-sm"><h3 class="font-bold">${i.product_name}</h3><a href="${i.purchase_link}" target="_blank" class="text-blue-500 text-sm truncate block">Link Pembelian</a></div>`).join('')}</div>`}
                </div>`;
        };

        UserModule.addReferenceModal = () => {
            Core.openGenericModal('Tambah Referensi', `<form onsubmit="event.preventDefault(); UserModule.saveReference(this)"><label class="block text-xs font-bold text-slate-500 mb-1">NAMA ALAT</label><input name="product_name" class="w-full border p-2 rounded mb-2" required><label class="block text-xs font-bold text-slate-500 mb-1">LINK</label><input name="purchase_link" class="w-full border p-2 rounded mb-4" required><button class="w-full bg-orange-500 text-white py-2 rounded">Simpan</button></form>`);
        };

        UserModule.saveReference = async (form) => {
            const d = Object.fromEntries(new FormData(form)); delete d.id;
            await Core.supabase.from('event_tools_references').insert(d);
            Core.showToast('Disimpan'); Core.toggleModal('modal-generic'); UserModule.renderReferences(document.getElementById('content-area'));
        };

        UserModule.renderDashboard = async (container) => {
            const regions = await Core.fetchRegions();
            const filtered = UserModule.dashboardFilterRegion === 'all' 
                ? UserModule.projects 
                : UserModule.projects.filter(p => p.regional === UserModule.dashboardFilterRegion);

            const total = filtered.length;
            let stage1 = 0, stage2 = 0, active = 0, completed = 0;

            filtered.forEach(p => {
                const step = UserModule.calculateEffectiveStep(p);
                if(step === 1) stage1++;
                else if(step === 2) stage2++;
                else if(step >= 3 && step <= 5) active++;
                else if(step === 6) completed++;
            });

            container.innerHTML = `
                <div class="fade-in space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800">Dashboard Overview</h2>
                        <select onchange="UserModule.dashboardFilterRegion=this.value; UserModule.renderDashboard(document.getElementById('content-area'))" class="border border-slate-300 rounded-lg px-4 py-2 text-sm bg-white shadow-sm focus:ring-2 focus:ring-green-500 outline-none cursor-pointer">
                            <option value="all">Semua Regional</option>
                            ${regions.map(r => `<option value="${r.name}" ${UserModule.dashboardFilterRegion===r.name?'selected':''}>${r.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm"><div class="text-xs text-slate-500 uppercase font-bold mb-1">Total Proyek</div><div class="text-3xl font-bold text-slate-800">${total}</div></div>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-sm"><div class="text-xs text-blue-600 uppercase font-bold mb-1">Proposal (Thp 1)</div><div class="text-3xl font-bold text-blue-800">${stage1}</div></div>
                        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100 shadow-sm"><div class="text-xs text-yellow-600 uppercase font-bold mb-1">Finance (Thp 2)</div><div class="text-3xl font-bold text-yellow-800">${stage2}</div></div>
                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-100 shadow-sm"><div class="text-xs text-purple-600 uppercase font-bold mb-1">Berjalan (Thp 3-5)</div><div class="text-3xl font-bold text-purple-800">${active}</div></div>
                        <div class="bg-green-50 p-4 rounded-xl border border-green-100 shadow-sm"><div class="text-xs text-green-600 uppercase font-bold mb-1">Selesai (Thp 6)</div><div class="text-3xl font-bold text-green-800">${completed}</div></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm overflow-hidden">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm">Timeline Proyek Aktif</h3>
                        <div class="overflow-x-auto pb-2">${UserModule.renderGanttChart(filtered)}</div>
                    </div>
                </div>`;
        };
        
        UserModule.renderProjectList = async (container) => {
            const regions = await Core.fetchRegions();
            const filtered = UserModule.filterRegion === 'all' ? UserModule.projects : UserModule.projects.filter(p => p.regional === UserModule.filterRegion);
            
            container.innerHTML = `
                <div class="fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800">Daftar Proyek</h2>
                            <p class="text-slate-500">Kelola dan pantau semua kegiatan regional</p>
                        </div>
                        <div class="flex gap-3">
                            <div class="relative"><select onchange="UserModule.filterRegion=this.value;App.router('projects')" class="appearance-none border border-slate-200 rounded-xl pl-4 pr-10 py-2.5 text-sm font-medium focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all cursor-pointer hover:border-green-400"><option value="all">Semua Regional</option>${regions.map(r => `<option value="${r.name}" ${UserModule.filterRegion===r.name?'selected':''}>${r.name}</option>`).join('')}</select><i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i></div>
                            <button onclick="UserModule.openNewProjectModal()" class="bg-green-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-green-200 hover:bg-green-700 hover:shadow-green-300 transition-all flex items-center gap-2 transform active:scale-95"><i class="fas fa-plus"></i> Buat Proyek</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${filtered.map(p => {
                            const pJson = JSON.stringify({id: p.id, title: p.title, event_date: p.event_date, location: p.location, regional: p.regional, leader: p.leader, estimated_delegates: p.estimated_delegates, volunteer_price: p.volunteer_price}).replace(/"/g, '&quot;');
                            const stepNum = UserModule.calculateEffectiveStep(p);
                            const progress = (stepNum / 6) * 100;
                            let statusColor = 'bg-slate-100 text-slate-600 border-slate-200';
                            if (stepNum >= 6) statusColor = 'bg-green-50 text-green-700 border-green-200';
                            else if (stepNum >= 3) statusColor = 'bg-blue-50 text-blue-700 border-blue-200';
                            else if (stepNum === 2) statusColor = 'bg-yellow-50 text-yellow-700 border-yellow-200';
                            const stepName = Core.SOP_STEPS.find(s => s.id === stepNum)?.name || '';
                            const dynamicStatus = `Tahap ${stepNum}: ${stepName}`;

                            return `
                            <div onclick="UserModule.openProjectDetail('${p.id}', ${stepNum})" class="bg-white rounded-2xl border border-slate-100 p-6 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer group flex flex-col h-full relative overflow-hidden">
                                <div class="absolute top-0 left-0 right-0 h-1.5 bg-gradient-to-r from-green-400 to-emerald-600"></div>
                                <div class="flex justify-between items-start mb-4 mt-2">
                                    <span class="inline-flex items-center gap-1.5 bg-slate-50 text-slate-600 text-[10px] font-bold uppercase tracking-wider px-2.5 py-1 rounded-full border border-slate-200"><i class="fas fa-map-marker-alt text-red-400"></i> ${p.regional}</span>
                                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity absolute right-4 top-6 bg-white shadow-sm rounded-lg p-1 border z-10">
                                        <button onclick="event.stopPropagation(); UserModule.openEditProjectModal(${pJson})" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-md transition" title="Edit"><i class="fas fa-pen"></i></button>
                                    </div>
                                </div>
                                <h3 class="font-bold text-xl text-slate-800 mb-2 leading-tight group-hover:text-green-700 transition-colors line-clamp-2">${p.title}</h3>
                                <div class="flex items-center gap-4 text-xs text-slate-500 mb-4">
                                    <span class="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded"><i class="far fa-calendar-alt text-blue-400"></i> ${Core.formatDate(p.event_date)}</span>
                                    <span class="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded"><i class="far fa-user text-orange-400"></i> ${p.leader || 'Belum ada'}</span>
                                </div>
                                <div class="mt-auto">
                                    <div class="flex justify-between items-center mb-1.5"><span class="text-xs font-semibold text-slate-600">Progress: Tahap ${stepNum}/6</span><span class="text-xs font-bold text-emerald-600">${Math.round(progress)}%</span></div>
                                    <div class="w-full bg-slate-100 rounded-full h-2 mb-4 overflow-hidden"><div class="bg-gradient-to-r from-green-400 to-emerald-600 h-2 rounded-full transition-all duration-1000" style="width: ${progress}%"></div></div>
                                    <div class="flex items-center justify-between pt-3 border-t border-slate-50"><div class="px-3 py-1 rounded-lg text-xs font-bold border ${statusColor} truncate max-w-[180px]" title="${dynamicStatus}">${dynamicStatus}</div><div class="text-xs text-slate-400 group-hover:translate-x-1 transition-transform font-medium">Detail <i class="fas fa-arrow-right ml-1"></i></div></div>
                                </div>
                            </div>`}).join('')}
                    </div>
                    ${filtered.length === 0 ? `<div class="flex flex-col items-center justify-center py-20 text-center"><div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-4"><i class="fas fa-folder-open text-3xl text-slate-300"></i></div><h3 class="text-lg font-bold text-slate-600">Belum ada proyek</h3></div>` : ''}
                </div>`;
        };
        
        UserModule.openNewProjectModal = async () => {
            const regions = await Core.fetchRegions();
            const options = regions.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
            const html = `<form onsubmit="event.preventDefault(); UserModule.createProject(this)"><input name="title" placeholder="Nama Kegiatan" class="w-full border p-2 rounded mb-2" required><div class="grid grid-cols-2 gap-2 mb-2"><select name="regional" class="border p-2 rounded" required><option value="">Pilih Regional</option>${options}</select><input name="leader" placeholder="Leader" class="w-full border p-2 rounded"></div><input type="date" name="event_date" class="w-full border p-2 rounded mb-2" required><input name="location" placeholder="Lokasi" class="w-full border p-2 rounded mb-4"><button class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700 transition">Simpan</button></form>`;
            Core.openGenericModal('Proyek Baru', html);
        };

        UserModule.createProject = async (form) => {
            const d = Object.fromEntries(new FormData(form)); d.status = 'Tahap 1: Submit Proposal'; d.step = '1';
            const { data, error } = await Core.supabase.from('projects').insert(d).select();
            if(data) { await Core.supabase.from('events').upsert({region: d.regional, name: d.title, budget_limit: 0, status: 'active'}, {onConflict: 'region,name'}); Core.toggleModal('modal-generic'); Core.showToast('Proyek Dibuat'); App.router('projects'); }
        };

        UserModule.openProjectDetail = async (id, stepId = 1) => {
            UserModule.activeProjectId = id;
            UserModule.rabInputs = { delegates: 0, price: 0 };
            const container = document.getElementById('content-area'); container.innerHTML = '<div class="flex h-full items-center justify-center"><div class="loading-spinner"></div></div>';
            const { data: p } = await Core.supabase.from('projects').select('*').eq('id', id).single();
            if(!p) return App.router('projects');
            const [rundowns, budgets, volunteers, approvals, games] = await Promise.all([
                Core.supabase.from('rundowns').select('*').eq('project_id', id).order('time_start'),
                Core.supabase.from('budgets').select('*').eq('project_id', id).order('id'),
                Core.supabase.from('volunteers').select('*').eq('project_id', id),
                Core.supabase.from('project_approvals').select('*').eq('project_id', id),
                Core.supabase.from('project_games').select('*').eq('project_id', id)
            ]);
            p.project_approvals = approvals.data || [];
            UserModule.renderDetailView(container, p, { rundowns: rundowns.data, budgets: budgets.data, volunteers: volunteers.data, approvals: approvals.data, games: games.data }, stepId);
        };

        UserModule.advanceStep = async (pid, nextStep) => {
            const stepName = Core.SOP_STEPS.find(s => s.id === nextStep)?.name || '';
            const statusText = `Tahap ${nextStep}: ${stepName}`;
            const { error } = await Core.supabase.from('projects').update({ step: nextStep.toString(), status: statusText }).eq('id', pid);
            if (error) Core.showToast('Gagal update step: ' + error.message);
            else { Core.showToast(`Berhasil lanjut ke Tahap ${nextStep}`); UserModule.openProjectDetail(pid, nextStep); }
        };

        UserModule.renderDetailView = (container, p, r, sid) => {
            const getStatus = (stepId) => r.approvals?.find(a => a.step_number === stepId)?.status || 'pending';
            const status = getStatus(sid);
            const step = Core.SOP_STEPS.find(s => s.id === sid);
            
            const isFinanceApproved = getStatus(2) === 'approved';
            const isLocked = isFinanceApproved; 

            let controls = '';
            if(step.requiresApproval) {
                if(status === 'pending') controls = `<button onclick="UserModule.submitApproval('${p.id}', ${sid})" class="bg-blue-600 text-white w-full py-2 rounded font-bold">Ajukan ke Finance</button>`;
                else if(status === 'submitted') controls = `<div class="bg-yellow-50 text-yellow-800 p-4 rounded text-center border border-yellow-200">Menunggu Verifikasi Finance<br><span class="text-xs">Hubungi Admin Finance</span></div>`;
                else if(status === 'approved') controls = `<div class="bg-green-50 text-green-800 p-3 rounded text-center font-bold mb-2 border border-green-200">Disetujui oleh Finance</div>${sid<6 ? `<button onclick="UserModule.advanceStep('${p.id}',${sid+1})" class="bg-slate-100 w-full py-2 rounded hover:bg-slate-200 transition font-bold border border-slate-300">Lanjut Step ${sid+1}</button>`:''}`;
                else {
                    const note = r.approvals.find(a=>a.step_number===sid)?.notes || '-';
                    controls = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4 rounded-r shadow-sm text-left animate-pulse">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-circle text-red-500 mt-0.5 mr-3 text-lg"></i>
                            <div>
                                <h4 class="text-red-800 font-bold text-sm">Pengajuan Ditolak</h4>
                                <p class="text-red-700 text-sm mt-1 font-medium">"${note}"</p>
                                <p class="text-red-600 text-xs mt-2 italic">Silakan revisi data di atas sesuai catatan, lalu ajukan ulang.</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="UserModule.submitApproval('${p.id}',${sid})" class="bg-slate-700 text-white w-full py-3 rounded-xl hover:bg-slate-800 transition font-bold shadow-lg flex justify-center items-center gap-2"><i class="fas fa-paper-plane"></i> Ajukan Ulang</button>`;
                }
            } else {
                controls = `<button onclick="UserModule.advanceStep('${p.id}',${sid+1})" class="bg-teal-600 text-white w-full py-2 rounded font-bold hover:bg-teal-700 transition">Selesai, Lanjut</button>`;
            }

            const stepsHtml = Core.SOP_STEPS.map(s => {
                const currentEffectiveStep = UserModule.calculateEffectiveStep(p);
                const st = getStatus(s.id);
                const icon = st === 'approved' ? 'fa-check text-green-500' : 'fa-circle text-slate-300';
                let locked = false;
                const dbStep = parseInt(p.step) || 1;
                if (s.id > dbStep + 1) locked = true;
                if (s.id > 2 && getStatus(2) !== 'approved') locked = true;
                return `<button onclick="${locked?'':`UserModule.openProjectDetail('${p.id}',${s.id})`}" class="flex flex-col items-center min-w-[100px] p-2 rounded-xl mx-1 ${sid===s.id?'bg-green-600 text-white':'bg-white text-slate-600 border'} ${locked?'opacity-50 cursor-not-allowed': 'hover:shadow-md'}"><div class="text-xs font-bold">Tahap ${s.id}</div><div class="text-[10px]">${s.name}</div><i class="fas ${icon} text-xs absolute -top-1 -right-1 bg-white rounded-full p-1 border"></i></button>`;
            }).join('');

            let body = `<div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded mb-6"><p class="font-bold text-sm">Deadline: ${step.desc}</p></div>`;
            const pJson = JSON.stringify({id: p.id, title: p.title, event_date: p.event_date, location: p.location, regional: p.regional, leader: p.leader}).replace(/"/g, '&quot;');
            const infoCard = `<div class="bg-white border p-4 rounded-xl shadow-sm mb-6 flex flex-col md:flex-row justify-between items-start md:items-center"><div><div class="flex items-center gap-2 mb-1"><span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">${p.regional}</span><h1 class="text-xl font-bold text-slate-800">${p.title}</h1><button onclick="UserModule.openEditProjectModal(${pJson})" class="text-slate-400 hover:text-blue-600"><i class="fas fa-pencil-alt"></i></button></div><div class="flex gap-4 text-sm text-slate-500 mt-2"><div class="flex items-center gap-1"><i class="fas fa-user-circle text-gray-400"></i> ${p.leader || '-'}</div><div class="flex items-center gap-1"><i class="fas fa-map-marker-alt text-gray-400"></i> ${p.location || '-'}</div><div class="flex items-center gap-1"><i class="fas fa-calendar-alt text-gray-400"></i> ${Core.formatDate(p.event_date)}</div></div></div></div>`;

            if (sid === 2) {
                let defDelegates = p.estimated_delegates || UserModule.rabInputs.delegates || 0;
                let defPrice = p.volunteer_price || UserModule.rabInputs.price || 0;
                UserModule.rabInputs.delegates = defDelegates; UserModule.rabInputs.price = defPrice;
                const totalIncome = defDelegates * defPrice;
                const limits = { 'Komponen A': totalIncome * 0.4, 'Komponen B': totalIncome * 0.2, 'Komponen C': 500000, 'Komponen D': totalIncome * 0.1 };
                const actuals = { 'Komponen A': 0, 'Komponen B': 0, 'Komponen C': 0, 'Komponen D': 0 };
                let grandTotal = 0;
                (r.budgets||[]).forEach(b => { grandTotal += (b.total_price || 0); const match = b.item_name.match(/^\[(Komponen [ABCD])\]/); if(match && match[1]) { actuals[match[1]] += (b.total_price || 0); } else { actuals['Komponen A'] += (b.total_price || 0); } });

                UserModule.updateCalculator = async () => {
                        const dInput = document.getElementById('calc-delegates'); const pInput = document.getElementById('calc-price');
                        const d = dInput ? (parseInt(dInput.value) || 0) : 0; const pr = pInput ? (parseFloat(pInput.value) || 0) : 0;
                        UserModule.rabInputs.delegates = d; UserModule.rabInputs.price = pr; const inc = d * pr;
                        document.getElementById('calc-income').innerText = Core.formatCurrency(inc);
                        document.getElementById('limit-val-A').innerText = Core.formatCurrency(inc * 0.4);
                        document.getElementById('limit-val-B').innerText = Core.formatCurrency(inc * 0.2);
                        document.getElementById('limit-val-D').innerText = Core.formatCurrency(inc * 0.1);
                        if(UserModule.calcTimeout) clearTimeout(UserModule.calcTimeout);
                        UserModule.calcTimeout = setTimeout(async () => { await Core.supabase.from('projects').update({ estimated_delegates: d, volunteer_price: pr }).eq('id', p.id); await UserModule.autoUpsertFixedItems(p.id, 500000, inc * 0.1); }, 1000);
                };

                const getStatusColor = (act, lim) => act > lim ? 'text-red-600 font-bold' : 'text-green-600';
                const calcButton = isLocked ? '<div class="text-xs text-green-600 font-bold mb-4 bg-green-50 p-2 rounded border border-green-200"><i class="fas fa-lock mr-1"></i> Anggaran Telah Disetujui (Mode Baca & Upload Bukti Saja)</div>' : '<button onclick="UserModule.updateCalculator()" class="w-full bg-blue-600 text-white py-2 rounded mb-4 font-bold hover:bg-blue-700 transition shadow-sm"><i class="fas fa-save mr-2"></i>Simpan & Hitung</button>';
                
                const calcHtml = `<div class="bg-gray-50 p-5 rounded-xl border border-gray-200 mb-6"><h4 class="font-bold text-gray-700 mb-4 border-b pb-2"><i class="fas fa-calculator mr-2"></i>Perencanaan Anggaran</h4><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="block text-xs font-bold text-gray-500 mb-1">Jumlah Delegasi</label><input id="calc-delegates" type="number" class="w-full border p-2 rounded text-sm bg-white" value="${defDelegates}" ${isLocked?'disabled':''}></div><div><label class="block text-xs font-bold text-slate-500 mb-1">Harga Volunteer (Rp)</label><input id="calc-price" type="number" class="w-full border p-2 rounded text-sm bg-white" value="${defPrice}" ${isLocked?'disabled':''}></div></div>${calcButton}<div class="flex justify-between items-center bg-blue-100 p-3 rounded mb-4"><span class="text-sm font-bold text-blue-800">Total Pemasukan (Estimasi):</span><span id="calc-income" class="text-lg font-bold text-blue-900">${Core.formatCurrency(totalIncome)}</span></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs"><div class="bg-white p-3 rounded border shadow-sm"><div class="font-bold text-gray-700 mb-1">Komponen A (Alat & Bahan) - 40%</div><div class="flex justify-between items-center"><span class="text-gray-500">Limit: <span id="limit-val-A">${Core.formatCurrency(limits['Komponen A'])}</span></span><span class="${getStatusColor(actuals['Komponen A'], limits['Komponen A'])}">Pakai: ${Core.formatCurrency(actuals['Komponen A'])}</span></div></div><div class="bg-white p-3 rounded border shadow-sm"><div class="font-bold text-gray-700 mb-1">Komponen B (Konsumsi) - 20%</div><div class="flex justify-between items-center"><span class="text-gray-500">Limit: <span id="limit-val-B">${Core.formatCurrency(limits['Komponen B'])}</span></span><span class="${getStatusColor(actuals['Komponen B'], limits['Komponen B'])}">Pakai: ${Core.formatCurrency(actuals['Komponen B'])}</span></div></div><div class="bg-gray-100 p-3 rounded border shadow-sm opacity-80"><div class="font-bold text-gray-600 mb-1">Komponen C (Fixed) - Auto</div><div class="flex justify-between items-center"><span class="text-gray-500">Tetap: 500rb</span><span class="font-bold text-blue-600">${Core.formatCurrency(actuals['Komponen C'])}</span></div></div><div class="bg-gray-100 p-3 rounded border shadow-sm opacity-80"><div class="font-bold text-gray-600 mb-1">Komponen D (Lain-lain) - Auto 10%</div><div class="flex justify-between items-center"><span class="text-gray-500">Limit: <span id="limit-val-D">${Core.formatCurrency(limits['Komponen D'])}</span></span><span class="font-bold text-blue-600">${Core.formatCurrency(actuals['Komponen D'])}</span></div></div></div></div>`;

                const renderCategoryRows = (catName, title, isAuto = false) => {
                    const items = (r.budgets||[]).filter(b => { if(catName === 'Komponen A') return b.item_name.startsWith(`[${catName}]`) || !b.item_name.startsWith('['); return b.item_name.startsWith(`[${catName}]`); });
                    if(items.length === 0) return '';
                    const rows = items.map(b => {
                        const bJson = JSON.stringify(b).replace(/"/g, '&quot;');
                        const cleanName = b.item_name.replace(/^\[.*?\]\s/, '');
                        const hasInvoice = b.invoice_url ? true : false;
                        const uploadBtn = `<label class="cursor-pointer text-[9px] text-blue-500 hover:underline" title="Upload Invoice"><i class="fas fa-upload"></i> ${hasInvoice ? 'Ganti' : 'Inv'}<input type="file" class="hidden" onchange="UserModule.uploadBudgetProof('${p.id}', '${b.id}', this.files[0])"></label>`;
                        const viewBtn = hasInvoice ? `<a href="${b.invoice_url}" target="_blank" class="text-green-600 ml-1"><i class="fas fa-file-invoice"></i></a>` : '';
                        let actionButtons = `<div class="flex items-center gap-1 justify-end">${viewBtn} ${uploadBtn}`;
                        if (!isLocked && !isAuto) { actionButtons += `<button onclick="UserModule.editBudget('${p.id}', ${bJson})" class="text-[9px] text-slate-400 hover:text-blue-500 p-1"><i class="fas fa-pen"></i></button><button onclick="UserModule.deleteItem('budgets', '${b.id}', '${p.id}')" class="text-[9px] text-slate-400 hover:text-red-500 p-1"><i class="fas fa-trash"></i></button>`; }
                        actionButtons += `</div>`;
                        return `<div class="flex justify-between items-center border-b pb-1 pt-1 hover:bg-slate-50 text-xs pl-2"><div class="flex-1"><div class="font-medium text-slate-800">${cleanName}</div><div class="text-[10px] text-slate-500">${b.quantity} x ${Core.formatCurrency(b.unit_price)} ${hasInvoice ? '<span class="ml-1 text-green-600"><i class="fas fa-check-circle"></i></span>' : ''}</div></div><div class="text-right"><div class="font-bold text-slate-700">${Core.formatCurrency(b.total_price)}</div>${actionButtons}</div></div>`;
                    }).join('');
                    const subtotal = items.reduce((sum, b) => sum + (b.total_price||0), 0);
                    return `<div class="mb-3 bg-white border rounded p-2 shadow-sm"><h5 class="text-xs font-bold text-gray-700 border-b pb-2 mb-2 flex justify-between bg-gray-50 p-2 rounded -mx-2 -mt-2"><span>${title}</span><span class="text-blue-600">${Core.formatCurrency(subtotal)}</span></h5>${rows}</div>`;
                };

                const rabContent = `${renderCategoryRows('Komponen A', 'Alat & Bahan (Komponen A)')}${renderCategoryRows('Komponen B', 'Konsumsi (Komponen B)')}${renderCategoryRows('Komponen C', 'Fixed Cost (Komponen C - Otomatis)', true)}${renderCategoryRows('Komponen D', 'Lain-lain (Komponen D - Otomatis)', true)}`;

                const addButtons = isLocked ? '' : `<div class="flex gap-2"><button onclick="UserModule.addItemModal('budgets','${p.id}', 'Komponen A')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow transition">+ Alat & Bahan</button><button onclick="UserModule.addItemModal('budgets','${p.id}', 'Komponen B')" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow transition">+ Konsumsi</button></div>`;

                body += `${calcHtml}<div class="flex justify-between items-center mb-3 mt-6 pb-2 border-b border-gray-200"><h4 class="font-bold text-lg text-slate-800">Daftar Item Belanja</h4>${addButtons}</div><div class="space-y-1 mb-6">${rabContent || '<div class="text-center py-4 text-slate-400 italic bg-slate-50 rounded">Belum ada item belanja.</div>'}<div class="flex justify-between font-bold pt-3 border-t-2 border-slate-200 mt-2 text-lg text-blue-800"><span>Total Pengajuan</span><span>${Core.formatCurrency(grandTotal)}</span></div></div><div class="mt-8 border-t pt-4"><div class="flex justify-between items-center mb-2"><h4 class="font-bold text-slate-700">Ringkasan Kegiatan</h4><button onclick="UserModule.openRundownModal('${p.id}')" class="text-xs text-blue-600 hover:underline">+ Edit Rundown</button></div>
                <div class="bg-slate-50 p-3 rounded text-xs text-slate-600 space-y-1">
                    ${(r.rundowns||[]).map(rd => {
                        const rdJson = JSON.stringify(rd).replace(/"/g, '&quot;');
                        return `<div class="flex justify-between items-center border-b pb-2 mb-2">
                            <div><div class="font-bold text-slate-700 text-xs">${rd.time_start} - ${rd.time_end}</div><div class="text-sm">${rd.activity}</div></div>
                            <div class="flex gap-2"><button onclick="UserModule.editRundown('${p.id}', ${rdJson})" class="text-blue-500 hover:text-blue-700"><i class="fas fa-pen"></i></button><button onclick="UserModule.deleteItem('rundowns', '${rd.id}', '${p.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></div>
                        </div>`;
                    }).join('')}
                </div></div><label class="text-xs font-bold text-slate-500 block mt-4">LINK POSTER</label><input value="${p.poster_link||''}" onchange="UserModule.updateField('${p.id}','poster_link',this.value)" class="w-full border p-2 rounded">`;
            } else if (sid === 1) {
                const gameRows = (r.games||[]).map(g => { const gJson = JSON.stringify(g).replace(/"/g, '&quot;'); return `<div class="flex justify-between items-center border-b pb-1"><div class="flex-1"><div class="font-medium">${g.title}</div><div class="text-xs text-blue-500 truncate"><a href="${g.link}" target="_blank">${g.link||'-'}</a></div></div><div class="flex gap-1 ml-2"><button onclick="UserModule.editGame('${p.id}', ${gJson})" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fas fa-edit"></i></button><button onclick="UserModule.deleteItem('project_games', '${g.id}', '${p.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button></div></div>`; }).join('');
                body += `<label class="text-xs font-bold text-slate-500">TARGET AUDIENCE</label><input value="${p.target_audience||''}" onchange="UserModule.updateField('${p.id}','target_audience',this.value)" class="w-full border p-2 rounded mb-2"><label class="text-xs font-bold text-slate-500">KONSEP ACARA</label><textarea onchange="UserModule.updateField('${p.id}','concept_note',this.value)" class="w-full border p-2 rounded mb-4" rows="4">${p.concept_note||''}</textarea><div class="flex justify-between items-center mb-2"><h4 class="font-bold text-slate-700">Games & Referensi</h4><button onclick="UserModule.addItemModal('project_games','${p.id}')" class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded hover:bg-purple-200 transition">+ Tambah</button></div><div class="bg-slate-50 p-3 rounded border mb-4 text-sm space-y-2">${gameRows.length ? gameRows : '<div class="text-slate-400 italic">Belum ada games/referensi</div>'}</div>`;
            } else if (sid === 3) {
                    const volRows = (r.volunteers||[]).map(v => { const vJson = JSON.stringify(v).replace(/"/g, '&quot;'); return `<div class="bg-slate-50 p-2 rounded border text-sm flex justify-between items-center"><span>${v.role_name}</span><div class="flex gap-2 font-bold items-center"><span>${v.count}</span><div class="flex gap-1 border-l pl-2 ml-2 border-slate-300"><button onclick="UserModule.editVolunteer('${p.id}', ${vJson})" class="text-blue-500 font-normal hover:text-blue-700"><i class="fas fa-edit"></i></button><button onclick="UserModule.deleteItem('volunteers', '${v.id}', '${p.id}')" class="text-red-400 font-normal hover:text-red-600"><i class="fas fa-trash"></i></button></div></div></div>`; }).join('');
                    const isFinanceApproved = getStatus(2) === 'approved';
                    body += `<div class="flex justify-between mb-2"><h4 class="font-bold">Relawan</h4><button onclick="UserModule.addItemModal('volunteers','${p.id}')" class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded hover:bg-orange-200 transition">+ Divisi</button></div><div class="grid grid-cols-2 gap-2 mb-4">${volRows}</div><label class="text-xs font-bold text-slate-500">STATUS LOGISTIK</label><select onchange="UserModule.updateField('${p.id}','purchase_status',this.value)" class="w-full border p-2 rounded"><option ${p.purchase_status==='Belum'?'selected':''}>Belum</option><option ${p.purchase_status==='Proses'?'selected':''}>Proses</option><option ${p.purchase_status==='Selesai'?'selected':''}>Selesai</option></select>${isFinanceApproved ? `<button onclick="PDFService.generate('${p.id}')" class="w-full mt-4 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition shadow"><i class="fas fa-file-pdf mr-2"></i> Download PDF (Rundown & RAB)</button>` : ''}`;
            } else if (sid === 4) {
                body += `<label class="text-xs font-bold text-slate-500">CATATAN FIRST MEET</label><textarea onchange="UserModule.updateField('${p.id}','firstmeet_notes',this.value)" class="w-full border p-2 rounded mb-4" rows="4">${p.firstmeet_notes||''}</textarea><div class="bg-slate-50 p-4 rounded-xl border border-dashed border-slate-300"><h4 class="font-bold text-slate-700 text-sm mb-2"><i class="fas fa-cloud-upload-alt mr-2"></i>Bukti First Meet (Foto/Absensi)</h4><div class="space-y-3"><input type="file" onchange="UserModule.uploadFile('${p.id}','proofs',this.files[0],'firstmeet_proof')" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" /><input value="${p.firstmeet_proof||''}" onchange="UserModule.updateField('${p.id}','firstmeet_proof',this.value)" class="w-full border p-2 rounded text-sm bg-white" placeholder="Tempel Link Google Drive / Dropbox disini">${p.firstmeet_proof ? `<div class="mt-2"><img src="${p.firstmeet_proof}" class="h-32 rounded border shadow-sm object-cover hover:h-auto"><a href="${p.firstmeet_proof}" target="_blank" class="text-xs text-blue-500 underline block mt-1">Lihat Gambar Full</a></div>` : ''}</div></div>`;
            } else if (sid === 5) {
                    body += `<label class="text-xs font-bold text-slate-500">CATATAN EVALUASI EVENT</label><textarea onchange="UserModule.updateField('${p.id}','eventday_notes',this.value)" class="w-full border p-2 rounded" rows="5">${p.eventday_notes||''}</textarea>`;
            } else if (sid === 6) {
                    body += `<label class="text-xs font-bold text-slate-500">ISI LAPORAN</label><textarea onchange="UserModule.updateField('${p.id}','report_content',this.value)" class="w-full border p-2 rounded mb-4" rows="5">${p.report_content||''}</textarea><div class="bg-slate-50 p-4 rounded-xl border border-dashed border-slate-300 mb-4"><h4 class="font-bold text-slate-700 text-sm mb-2"><i class="fas fa-cloud-upload-alt mr-2"></i>Bukti Laporan Akhir (Foto Kegiatan)</h4><div class="space-y-3"><input type="file" onchange="UserModule.uploadFile('${p.id}','proofs',this.files[0],'report_proof')" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" /><input value="${p.report_proof||''}" onchange="UserModule.updateField('${p.id}','report_proof',this.value)" class="w-full border p-2 rounded text-sm bg-white" placeholder="Tempel Link Google Drive / Dropbox disini">${p.report_proof ? `<div class="mt-2"><img src="${p.report_proof}" class="h-32 rounded border shadow-sm object-cover hover:h-auto"><a href="${p.report_proof}" target="_blank" class="text-xs text-blue-500 underline block mt-1">Lihat Gambar Full</a></div>` : ''}</div></div>${status==='approved' ? `<button onclick="PDFService.generate('${p.id}')" class="w-full bg-red-600 text-white py-3 rounded font-bold hover:bg-red-700 transition"><i class="fas fa-file-pdf mr-2"></i> Export Laporan PDF Lengkap</button>` : ''}`;
            }

            container.innerHTML = `<div class="fade-in pb-20"><button onclick="App.router('projects')" class="text-sm mb-4"><i class="fas fa-arrow-left"></i> Kembali</button>${infoCard}<div class="flex overflow-x-auto pb-4 mb-4">${stepsHtml}</div><div class="bg-white rounded-2xl p-6 border shadow-sm mb-6"><div>${body}</div><div class="mt-4 pt-4 border-t">${controls}</div></div></div>`;
        };
        
        // ... (Rest of functions like autoUpsertFixedItems, submitApproval, addItemModal, saveItem, editBudget, etc. same as above)
        
        UserModule.autoUpsertFixedItems = async (pid, valC, valD) => {
            const { data: existingC } = await Core.supabase.from('budgets').select('id').eq('project_id', pid).ilike('item_name', '[Komponen C]%').single();
            const dataC = { project_id: pid, item_name: '[Komponen C] Fixed Cost (Sewa, dll)', quantity: 1, unit_price: valC }; 
            if(existingC) await Core.supabase.from('budgets').update({ unit_price: valC }).eq('id', existingC.id); else await Core.supabase.from('budgets').insert(dataC);
            const { data: existingD } = await Core.supabase.from('budgets').select('id').eq('project_id', pid).ilike('item_name', '[Komponen D]%').single();
            const dataD = { project_id: pid, item_name: '[Komponen D] Lain-lain (Promo, Merchandise)', quantity: 1, unit_price: valD };
            if(existingD) await Core.supabase.from('budgets').update({ unit_price: valD }).eq('id', existingD.id); else await Core.supabase.from('budgets').insert(dataD);
            await UserModule.syncBudgetToFinance(pid);
            UserModule.openProjectDetail(pid, 2);
        };
        UserModule.submitApproval = async (id, step) => { 
            if (step === 2) {
                // Fetch latest data to verify limits before submission
                const { data: project } = await Core.supabase.from('projects').select('estimated_delegates, volunteer_price').eq('id', id).single();
                const { data: budgets } = await Core.supabase.from('budgets').select('item_name, total_price').eq('project_id', id);

                const income = (project.estimated_delegates || 0) * (project.volunteer_price || 0);
                const limitA = income * 0.40;
                const limitB = income * 0.20;

                const actuals = { 'Komponen A': 0, 'Komponen B': 0 };
                budgets.forEach(b => {
                    const match = b.item_name.match(/^\[(Komponen [ABCD])\]/);
                    if(match && match[1]) {
                        if(actuals[match[1]] !== undefined) actuals[match[1]] += (b.total_price || 0);
                    } else {
                         actuals['Komponen A'] += (b.total_price || 0);
                    }
                });

                let errors = [];
                let suggestions = [];
                
                if (actuals['Komponen A'] > limitA) {
                    const diff = actuals['Komponen A'] - limitA;
                    errors.push(`Komponen A (Alat & Bahan) Over: ${Core.formatCurrency(diff)}`);
                    suggestions.push(`Kurangi belanja alat/bahan sebesar ${Core.formatCurrency(diff)}`);
                }
                if (actuals['Komponen B'] > limitB) {
                    const diff = actuals['Komponen B'] - limitB;
                    errors.push(`Komponen B (Konsumsi) Over: ${Core.formatCurrency(diff)}`);
                    suggestions.push(`Kurangi biaya konsumsi sebesar ${Core.formatCurrency(diff)}`);
                }

                if (errors.length > 0) {
                    suggestions.push("Naikkan harga tiket volunteer");
                    suggestions.push("Tambah target jumlah delegasi");

                    Swal.fire({
                        title: 'Pengajuan Ditolak Sistem',
                        html: `
                            <div class="text-left">
                                <p class="text-red-600 font-bold mb-2">Anggaran melebihi batas (Overbudget):</p>
                                <ul class="list-disc pl-5 text-sm text-red-500 mb-4">
                                    ${errors.map(e => `<li>${e}</li>`).join('')}
                                </ul>
                                <div class="bg-blue-50 p-3 rounded border border-blue-100">
                                    <p class="font-bold text-blue-800 mb-1 text-sm"><i class="fas fa-lightbulb mr-1"></i>Saran Perbaikan:</p>
                                    <ul class="list-disc pl-5 text-sm text-blue-700">
                                        ${suggestions.map(s => `<li>${s}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `,
                        icon: 'warning'
                    });
                    return; // Stop submission
                }
            }

            await Core.supabase.from('project_approvals').upsert({ project_id: id, step_number: step, status: 'submitted', submitted_at: new Date().toISOString(), notes: null }, { onConflict: 'project_id, step_number' });
            if (step === 2) await Core.supabase.from('projects').update({ finance_status: 'Pending' }).eq('id', id);
            Core.showToast('Diajukan ke Finance'); UserModule.openProjectDetail(id, step); 
        };
        UserModule.addItemModal = (table, pid, preselectedCategory = '') => {
            let html = `<input name="item_name" placeholder="Item" class="w-full border p-2 mb-2" required><div class="flex gap-2"><input name="quantity" type="number" class="w-full border p-2" placeholder="Qty" oninput="UserModule.calcTotal(this.form)"><input name="unit_price" type="number" class="w-full border p-2" placeholder="Harga" oninput="UserModule.calcTotal(this.form)"></div><input name="total_price" readonly class="w-full border p-2 bg-gray-100 mt-2">`;
            if (table === 'rundowns') {
                html = `<div class="flex gap-2 mb-2"><input type="time" name="time_start" class="w-full border p-2 rounded" required><input type="time" name="time_end" class="w-full border p-2 rounded" required></div><input name="activity" placeholder="Nama Kegiatan" class="w-full border p-2 rounded mb-2" required>`;
            }
            const saveFn = table === 'budgets' ? `UserModule.saveItem('${table}','${pid}',this, '${preselectedCategory}')` : `UserModule.saveItem('${table}','${pid}',this)`;
            Core.openGenericModal('Tambah', `<form onsubmit="event.preventDefault();${saveFn}">${html}<button class="w-full bg-green-600 text-white py-2 mt-2 rounded">Simpan</button></form>`);
        };
        UserModule.saveItem = async (table, pid, form, category = null) => {
            const d = Object.fromEntries(new FormData(form)); d.project_id = pid;
            if(table === 'budgets') { delete d.total_price; if(category) d.item_name = `[${category}] ${d.item_name}`; }
            if (d.id) await Core.supabase.from(table).update(d).eq('id', d.id); else { delete d.id; await Core.supabase.from(table).insert(d); }
            if(table === 'budgets') await UserModule.syncBudgetToFinance(pid);
            Core.toggleModal('modal-generic'); 
            let step = 1;
            if (table === 'budgets' || table === 'rundowns') step = 2;
            else if (table === 'volunteers') step = 3;
            else if (table === 'project_games') step = 1;
            UserModule.openProjectDetail(pid, step);
        };
        UserModule.editBudget = (pid, item) => { Core.openGenericModal('Edit Budget', `<form onsubmit="event.preventDefault(); UserModule.saveItem('budgets', '${pid}', this)"><input type="hidden" name="id" value="${item.id}"><label>Nama Item</label><input name="item_name" value="${item.item_name}" class="w-full border p-2 mb-2" required><div class="flex gap-2"><input name="quantity" type="number" value="${item.quantity}" class="w-full border p-2" oninput="UserModule.calcTotal(this.form)"><input name="unit_price" type="number" value="${item.unit_price}" class="w-full border p-2" oninput="UserModule.calcTotal(this.form)"></div><input name="total_price" readonly value="${item.total_price}" class="w-full border p-2 bg-slate-100 mt-2"><button class="w-full bg-blue-600 text-white py-2 mt-2 rounded">Update</button></form>`); };
        UserModule.editGame = (pid, item) => { Core.openGenericModal('Edit Game', `<form onsubmit="event.preventDefault(); UserModule.saveItem('project_games', '${pid}', this)"><input type="hidden" name="id" value="${item.id}"><label>Nama Game</label><input name="title" value="${item.title}" class="w-full border p-2 mb-2" required><label>Link</label><input name="link" value="${item.link || ''}" class="w-full border p-2 mb-4"><button class="w-full bg-blue-600 text-white py-2 rounded">Update</button></form>`); };
        UserModule.editRundown = (pid, item) => { Core.openGenericModal('Edit Rundown', `<form onsubmit="event.preventDefault(); UserModule.saveItem('rundowns', '${pid}', this)"><input type="hidden" name="id" value="${item.id}"><div class="flex gap-2"><input type="time" name="time_start" value="${item.time_start}" class="w-full border p-2"><input type="time" name="time_end" value="${item.time_end}" class="w-full border p-2"></div><input name="activity" value="${item.activity}" class="w-full border p-2 mt-2" required><button class="w-full bg-blue-600 text-white py-2 mt-2 rounded">Update</button></form>`); };
        UserModule.editVolunteer = (pid, item) => { Core.openGenericModal('Edit Volunteer', `<form onsubmit="event.preventDefault(); UserModule.saveItem('volunteers', '${pid}', this)"><input type="hidden" name="id" value="${item.id}"><input name="role_name" value="${item.role_name}" class="w-full border p-2 mb-2" required><input name="count" value="${item.count}" class="w-full border p-2 mb-4"><button class="w-full bg-blue-600 text-white py-2 rounded">Update</button></form>`); };
        UserModule.calcTotal = (form) => { form.total_price.value = (parseFloat(form.quantity.value)||0) * (parseFloat(form.unit_price.value)||0); };
        
        UserModule.deleteItem = async (table, id, pid) => { 
            if(!await Core.confirm('Hapus item ini?')) return; 
            const { error } = await Core.supabase.from(table).delete().eq('id', id); 
            if (error) { Core.showToast('Gagal hapus: ' + error.message); return; }
            if(table==='budgets') await UserModule.syncBudgetToFinance(pid); 
            let step = 1;
            if (table === 'budgets' || table === 'rundowns') step = 2;
            else if (table === 'volunteers') step = 3;
            else if (table === 'project_games') step = 1;
            UserModule.openProjectDetail(pid, step); 
        };

        UserModule.syncBudgetToFinance = async (pid) => { const { data: budgets } = await Core.supabase.from('budgets').select('total_price').eq('project_id', pid); const total = budgets ? budgets.reduce((sum, item) => sum + (item.total_price || 0), 0) : 0; const { data: p } = await Core.supabase.from('projects').select('title, regional').eq('id', pid).single(); if (p) await Core.supabase.from('events').upsert({ region: p.regional, name: p.title, budget_limit: total, status: 'active' }, { onConflict: 'region,name' }); };
        UserModule.openEditProjectModal = async (p) => { const regions = await Core.fetchRegions(); const options = regions.map(r => `<option value="${r.name}">${r.name}</option>`).join(''); Core.openGenericModal('Edit Info', `<form onsubmit="event.preventDefault();UserModule.updateProjectDetails(this,'${p.id}')"><label>Nama</label><input name="title" value="${p.title}" class="w-full border p-2 mb-2"><label>Regional</label><select name="regional" class="w-full border p-2 mb-2">${options}</select><button class="w-full bg-blue-600 text-white py-2 rounded">Update</button></form>`); };
        UserModule.updateProjectDetails = async (form, pid) => { const d = Object.fromEntries(new FormData(form)); await Core.supabase.from('projects').update(d).eq('id', pid); Core.toggleModal('modal-generic'); UserModule.openProjectDetail(pid, 1); };
        UserModule.updateField = async (id, col, val) => { const { error } = await Core.supabase.from('projects').update({[col]: val}).eq('id', id); if(error) { Core.showToast('Gagal Simpan DB: ' + error.message); return false; } if (col === 'title' || col === 'regional') UserModule.syncBudgetToFinance(id); Core.showToast('Tersimpan'); return true; };
        UserModule.uploadFile = async (pid, bucket, file, dbCol) => { if(!file || file.size > 500 * 1024) return; const fileName = `${pid}/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`; const { error } = await Core.supabase.storage.from(bucket).upload(fileName, file); if(!error) { const { data } = Core.supabase.storage.from(bucket).getPublicUrl(fileName); const success = await UserModule.updateField(pid, dbCol, data.publicUrl); if(success) setTimeout(() => UserModule.openProjectDetail(pid, dbCol === 'firstmeet_proof' ? 4 : 6), 1000); } };
        // submitApproval now calls the updated version with validation logic above
        UserModule.renderGanttChart = (list) => {
            if(!list.length) return '';
            const h = Array.from({length:20},(_,i)=>`<div class="w-8 shrink-0 text-center text-xs border-r">${i-10}</div>`).join('');
            return `<div class="min-w-[600px]"><div class="flex border-b pb-1"><div class="w-40 shrink-0">Project</div><div class="flex">${h}</div></div>${list.map(p=>`<div class="flex border-b py-1 hover:bg-slate-50"><div class="w-40 shrink-0 truncate pr-2 text-sm">${p.title}</div><div class="flex">${Array.from({length:20},(_,i)=>`<div class="w-8 shrink-0 border-r h-4 ${i===10?'bg-green-500':''}"></div>`).join('')}</div></div>`).join('')}</div>`;
        };
        
        // --- ADDED MISSING FUNCTION ---
        UserModule.uploadBudgetProof = async (pid, budgetId, file) => {
            if(!file) return;
            if(file.size > 2 * 1024 * 1024) { Core.showToast('File max 2MB'); return; }
            
            Core.showToast('Mengupload...');
            const fileName = `invoices/${pid}/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
            
            // UPDATED: Use 'proofs' bucket
            const { error } = await Core.supabase.storage.from('proofs').upload(fileName, file);
            
            if(error) {
                Core.showToast('Upload Gagal: ' + error.message);
                return;
            }
            
            // UPDATED: Use 'proofs' bucket
            const { data } = Core.supabase.storage.from('proofs').getPublicUrl(fileName);
            
            const { error: dbError } = await Core.supabase.from('budgets').update({ invoice_url: data.publicUrl }).eq('id', budgetId);
            
            if(dbError) {
                Core.showToast('DB Error: ' + dbError.message);
            } else {
                Core.showToast('Invoice Terupload');
                UserModule.openProjectDetail(pid, 2);
            }
        };

        const App = {
            init: () => { Core.checkDB(); App.router('projects'); },
            router: (r) => {
                const c = document.getElementById('content-area');
                document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('bg-green-50', 'text-green-700', 'bg-orange-50', 'bg-blue-50'));
                if(r==='dashboard'){ UserModule.loadData().then(()=>UserModule.renderDashboard(c)); }
                if(r==='projects'){ UserModule.loadData().then(()=>UserModule.renderProjectList(c)); }
                if(r==='references'){ UserModule.renderReferences(c); }
            }
        };
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>
